<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sociograma â€” SOCIOMAP</title>

  <!-- LIBRERÃA D3 -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      background: #0f172a;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 32px;
      text-align: center;
    }

    h1 {
      font-size: 36px;
      color: white;
      margin-bottom: 10px;
    }

    .grupo-info {
      text-align: left;
      max-width: 1200px;
      margin: 0 auto 20px auto;
      color: #e2e8f0;
      font-size: 18px;
      padding-left: 10px;
    }

    .grupo-info span {
      display: block;
      font-weight: bold;
      color: #38bdf8;
      font-size: 22px;
    }

    #sociograma {
      margin: 20px auto;
      background: white;
      border-radius: 8px;
      width: 100%;
      max-width: 1200px;
      height: 800px;
      position: relative;
    }

    .leyenda {
      margin-top: 30px;
      text-align: left;
      max-width: 600px;
      margin-inline: auto;
      font-size: 15px;
      background: #1e293b;
      padding: 20px;
      border-radius: 12px;
    }

    .leyenda span {
      display: inline-block;
      width: 18px;
      height: 18px;
      margin-right: 8px;
      vertical-align: middle;
      border-radius: 50%;
    }

    .tag {
      font-size: 12px;
      background: rgba(0,0,0,0.6);
      padding: 3px 6px;
      border-radius: 6px;
      fill: #fff;
      pointer-events: none;
    }

    footer {
      margin-top: 40px;
    }

    .footer-logo {
      height: 80px;
    }
  </style>
</head>

<body>

  <h1>Sociograma Interactivo</h1>
  <div class="grupo-info" id="grupo-info"></div>

  <!-- SOCIOGRAMA D3 -->
  <div id="sociograma"></div>
  <p style="font-size:15px; color:#a5f3fc;">ðŸ’¡ Puedes reorganizar los nodos manualmente para una mejor visualizaciÃ³n.</p>

  <div class="leyenda">
    <p><strong>Leyenda del Sociograma:</strong></p>
    <p><span style="background:#0ea5e9;"></span> Nodo (participante)</p>
    <p><span style="background:#facc15;"></span> LÃ­der (mÃ¡s votos positivos)</p>
    <p><span style="background:#22c55e;"></span> RelaciÃ³n positiva</p>
    <p><span style="background:#ef4444;"></span> RelaciÃ³n negativa</p>
    <p>El tamaÃ±o del nodo es proporcional a los votos positivos recibidos.</p>
  </div>

  <footer>
    <img src="logo.png" class="footer-logo" alt="LOGO">
    <p>Gracias por usar Sociomap ðŸ’™</p>
  </footer>

<script>
  history.pushState(null, null, location.href);
  window.onpopstate = () => history.go(1);

  const labels = JSON.parse(sessionStorage.getItem("socio_labels") || "[]");
  const matrix = JSON.parse(sessionStorage.getItem("socio_matrix") || "[]");
  const grupo = sessionStorage.getItem("socio_grupo") || "SIN NOMBRE";

  const fechaObj = new Date();
  const fechaFormateada = fechaObj.toLocaleDateString("es-ES", { year:'numeric', month:'long', day:'numeric' });

  document.getElementById("grupo-info").innerHTML = `
    <span>Grupo: ${grupo}</span>
    Fecha de anÃ¡lisis: ${fechaFormateada}
  `;

  const width = 1200, height = 800;
  const nodes = labels.map((name, i) => {
    let p=0, n=0;
    matrix.forEach(row => { if(row[i]==="+") p++; if(row[i]==="-") n++; });
    return {id:i, name, votosPos:p, votosNeg:n};
  });

  const liderIndex = nodes.reduce((a,c,i,arr) => c.votosPos > arr[a].votosPos ? i : a, 0);

  const links = [];
  matrix.forEach((row,i)=> row.forEach((v,j) => {
    if(v==="+"||v==="-") links.push({source:i, target:j, type:v});
  }));

  const svg = d3.select("#sociograma").append("svg")
    .attr("width", width).attr("height", height);

  const sim = d3.forceSimulation(nodes)
    .force("link", d3.forceLink(links).id(d=>d.id).distance(150))
    .force("charge", d3.forceManyBody().strength(-350))
    .force("center", d3.forceCenter(width/2, height/2));

  const linkElems = svg.append("g").selectAll("line")
    .data(links).enter().append("line")
    .attr("stroke", d=> d.type==="+" ? "#22c55e" : "#ef4444")
    .attr("stroke-width", 2);

  const nodeElems = svg.append("g").selectAll("g")
    .data(nodes).enter().append("g")
      .call(d3.drag().on("start", dragStart).on("drag", drag).on("end", dragEnd));

  nodeElems.append("circle")
    .attr("r", d=> 30 + d.votosPos * 3)
    .attr("fill", d=> d.id === liderIndex ? "#facc15" : "#0ea5e9");

  nodeElems.append("text")
    .text(d => d.name)
    .attr("font-size", "14px")
    .attr("fill", "#fff")
    .attr("text-anchor", "middle")
    .attr("dy", -8);

  nodeElems.append("text")
    .text(d => `+${d.votosPos} / -${d.votosNeg}`)
    .attr("class", "tag")
    .attr("text-anchor", "middle")
    .attr("dy", 20);

  sim.on("tick", () => {
    linkElems
      .attr("x1", d=>d.source.x)
      .attr("y1", d=>d.source.y)
      .attr("x2", d=>d.target.x)
      .attr("y2", d=>d.target.y);

    nodeElems.attr("transform", d=>`translate(${d.x},${d.y})`);
  });

  function dragStart(event,d){
    if (!event.active) sim.alphaTarget(0.3).restart();
    d.fx = d.x; d.fy = d.y;
  }

  function drag(event,d){
    d.fx = event.x; d.fy = event.y;
  }

  function dragEnd(event,d){
    if (!event.active) sim.alphaTarget(0);
    d.fx = null; d.fy = null;
  }
</script>

</body>
</html>



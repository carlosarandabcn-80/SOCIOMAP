<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sociograma — SOCIOMAP</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      background: #0f172a;
      color: #ffffff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 32px;
      text-align: center;
    }
    h1 {
      font-size: 34px;
      margin-bottom: 8px;
    }
    .subtitulo {
      font-size: 17px;
      margin-bottom: 20px;
      color: #cbd5e1;
    }
    #contenedor {
      background: #ffffff;
      max-width: 1200px;
      margin: auto;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4);
    }
    svg {
      width: 100%;
      height: 760px;
      border-radius: 12px;
      background: #ffffff;
      border: 2px dashed #e2e8f0;
    }
    .leyenda {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 16px;
      color: #0f172a;
      font-size: 14px;
    }
    .leyenda span {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
    }
    footer {
      margin-top: 24px;
      text-align: center;
      color: #0f172a;
      font-size: 14px;
    }
    footer img {
      height: 48px;
      display: block;
      margin: 0 auto 6px;
    }
  </style>
</head>
<body>

  <h1>Sociograma Interactivo Académico</h1>
  <div class="subtitulo" id="grupoInfo"></div>

  <div id="contenedor">
    <div id="sociograma"></div>

    <div class="leyenda">
      <span><div class="dot" style="background:#22c55e;"></div> Relación positiva</span>
      <span><div class="dot" style="background:#ef4444;"></div> Relación negativa</span>
      <span><div class="dot" style="background:#facc15;"></div> Líder sociométrico</span>
      <span><div class="dot" style="background:#60a5fa;"></div> Tamaño ∝ votos recibidos</span>
    </div>

    <footer>
      <img src="logo.png" alt="Logo">
      SOCIOMAP · by Aranda Tools · 2026
    </footer>
  </div>

  <script>
    let labels = JSON.parse(sessionStorage.getItem("socio_labels") || "null");
    let matrix = JSON.parse(sessionStorage.getItem("socio_matrix") || "null");
    let grupo = sessionStorage.getItem("socio_grupo") || "DEMO";

    let modoDemo = false;

    if (!labels || !matrix || labels.length === 0) {
      // Cargar ejemplo DEMO si no hay datos válidos
      labels = ["Ana", "Luis", "Sofía", "Pedro"];
      matrix = [
        ["0", "+", "-", "+"],
        ["-", "0", "+", "-"],
        ["+", "-", "0", "+"],
        ["-", "+", "-", "0"]
      ];
      modoDemo = true;
    }

    const fecha = new Date().toLocaleDateString("es-ES", {
      year: "numeric",
      month: "long",
      day: "numeric"
    });

    document.getElementById("grupoInfo").textContent = `Grupo: ${grupo} — ${fecha}${modoDemo ? " (Modo DEMO)" : ""}`;

    const nodes = labels.map((name, i) => {
      let positivos = 0, negativos = 0;
      matrix.forEach(row => {
        if (row[i] === "+") positivos++;
        if (row[i] === "-") negativos++;
      });
      return { id: i, name, positivos, negativos };
    });

    const leader = nodes.reduce((max, curr) => curr.positivos > max.positivos ? curr : max, nodes[0]);

    const links = [];
    matrix.forEach((row, i) => {
      row.forEach((val, j) => {
        if (val === "+" || val === "-") {
          links.push({ source: i, target: j, tipo: val });
        }
      });
    });

    const width = document.getElementById("contenedor").clientWidth;
    const height = 760;

    const svg = d3.select("#sociograma")
      .append("svg")
      .attr("viewBox", `0 0 ${width} ${height}`);

    svg.append("defs").append("filter")
      .attr("id", "glow")
      .html(`
        <feGaussianBlur stdDeviation="4" result="blur"/>
        <feMerge>
          <feMergeNode in="blur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      `);

    const simulation = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(links).id(d => d.id).distance(150))
      .force("charge", d3.forceManyBody().strength(-420))
      .force("center", d3.forceCenter(width / 2, height / 2));

    const link = svg.append("g")
      .selectAll("line")
      .data(links)
      .enter()
      .append("line")
      .attr("stroke", d => d.tipo === "+" ? "#22c55e" : "#ef4444")
      .attr("stroke-width", 2)
      .attr("stroke-dasharray", d => d.tipo === "-" ? "6,4" : "0");

    const node = svg.append("g")
      .selectAll("g")
      .data(nodes)
      .enter()
      .append("g")
      .call(
        d3.drag()
          .on("start", dragStart)
          .on("drag", dragged)
          .on("end", dragEnd)
      );

    node.append("circle")
      .attr("r", d => 26 + d.positivos * 3)
      .attr("fill", d => d.id === leader.id ? "#facc15" : "#60a5fa")
      .attr("stroke", "#334155")
      .attr("stroke-width", 2)
      .attr("filter", d => d.id === leader.id ? "url(#glow)" : null);

    node.append("text")
      .text(d => d.name)
      .attr("text-anchor", "middle")
      .attr("dy", ".35em")
      .attr("font-size", "13px")
      .attr("font-weight", "bold")
      .attr("fill", "#0f172a");

    simulation.on("tick", () => {
      link
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);

      node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    function dragStart(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }

    function dragEnd(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }
  </script>
</body>
</html>



<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Formulario Sociom√©trico ‚Äî SOCIOMAP</title>

  <!-- LIBRER√çAS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body{
      background:#0f172a;
      color:#e2e8f0;
      font-family:Arial, sans-serif;
      margin:0;
      padding:20px;
      text-align:center;
    }

    .container{
      max-width:1100px;
      margin:auto;
      background:rgba(255,255,255,0.05);
      padding:32px;
      border-radius:16px;
      animation:fadeIn 0.8s ease;
    }

    @keyframes fadeIn{
      from{opacity:0; transform:translateY(10px);}
      to{opacity:1; transform:translateY(0);}
    }

    img.logo{
      height:72px;
      background:white;
      border-radius:12px;
      padding:6px 14px;
      margin-top:24px;
    }

    h1{font-size:26px;margin-bottom:8px;}
    h3{margin-top:0;}

    input, select{
      width:100%;
      padding:10px;
      margin:6px 0;
      border-radius:8px;
      font-size:14px;
    }

    .btn{
      padding:8px 16px;
      border-radius:8px;
      border:none;
      background:#e2e8f0;
      color:#0f172a;
      font-weight:bold;
      cursor:pointer;
      transition:all .25s ease;
    }
    .btn:hover{background:#cbd5e1; transform:translateY(-1px);}

    .btn-large{
      padding:14px 30px;
      font-size:17px;
      background:#3b82f6;
      color:white;
    }
    .btn-large:hover{background:#2563eb;}

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
      animation:fadeIn .6s ease;
    }

    th,td{
      border:1px solid #475569;
      padding:6px;
      text-align:center;
    }
    th{background:#1e293b;}

    .checkOK{color:#22c55e;font-weight:bold;}

    .roles-table{
      background:white;
      color:black;
      border-radius:10px;
      padding:20px;
      margin-top:24px;
      animation:fadeIn .6s ease;
    }

    /* COLORES POR ROL (TABLA + GR√ÅFICO) */
    .rol-lider{background:#dcfce7;}
    .rol-rechazado{background:#fee2e2;}
    .rol-aislado{background:#e5e7eb;}
    .rol-ambivalente{background:#fef9c3;}
    .rol-integrado{background:#dbeafe;}

    /* GR√ÅFICO */
    .grafico-box{
      background:white;
      padding:20px;
      border-radius:12px;
      margin-top:24px;
      animation:fadeIn .6s ease;
    }

    /* BOTONES DE EXPORTACI√ìN */
    .export-row{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-top:30px;
      flex-wrap:wrap;
    }
    .export-row .btn{
      font-size:13px;
      padding:8px 14px;
    }

    footer{
      margin-top:14px;
      color:#94a3b8;
      font-size:14px;
    }
  </style>
</head>

<body>

<div class="container">

  <h1>Formulario Sociom√©trico</h1>
  <p>Introduce la tabla sociom√©trica (3 elecciones + y 3 rechazos ‚àí por persona).</p>

  <label>Nombre del grupo</label>
  <input id="grupo" type="text" placeholder="Ej.: Taller 3¬∫ ESO"/>

  <label>N√∫mero de participantes</label>
  <select id="num"></select>

  <label><input type="checkbox" id="custom"> Usar nombres personalizados</label>
  <input id="names" type="text" placeholder="Ana, Juan, Luc√≠a..." style="display:none;"/>

  <button class="btn" onclick="crearTabla()">Crear tabla</button>

  <div id="tabla"></div>

  <button class="btn btn-large" id="btnRanking" onclick="procesar()" disabled>Crear ranking</button>

  <div id="ranking"></div>

  <div class="grafico-box">
    <h3>üìä Gr√°fico de barras sociom√©trico (interactivo)</h3>
    <canvas id="chart"></canvas>
    <p style="font-size:14px;color:#64748b;">Pasa el cursor sobre las barras para explorar valores y roles.</p>
  </div>

  <!-- BOTONES EXPORTACI√ìN -->
  <div class="export-row">
    <button class="btn" onclick="exportar('tablaVotos','tabla_sociometrica')">Exportar tabla</button>
    <button class="btn" onclick="exportar('rankingBox','ranking_roles')">Exportar ranking</button>
    <button class="btn" onclick="exportarCanvas()">Exportar gr√°fico</button>
  </div>

  <img src="logo.png" class="logo" alt="SOCIOMAP">

  <footer>¬© SOCIOMAP ¬∑ Aranda Tools</footer>
</div>

<script>
const num=document.getElementById("num");
for(let i=7;i<=40;i++)num.innerHTML+=`<option>${i}</option>`;

document.getElementById("custom").onchange=e=>{
  document.getElementById("names").style.display=e.target.checked?"block":"none";
};

function crearTabla(){
  const n=num.value;
  const custom=document.getElementById("custom").checked;
  let names=custom
    ?document.getElementById("names").value.split(",").map(x=>x.trim())
    :Array.from({length:n},(_,i)=>"P"+(i+1));

  if(names.length!==+n)return alert("N√∫mero de nombres incorrecto");

  let h=`<table id="tablaVotos"><thead><tr><th>De\\A</th>`;
  names.forEach(x=>h+=`<th>${x}</th>`);
  h+=`<th>‚úî</th></tr></thead><tbody>`;

  names.forEach((r,i)=>{
    h+=`<tr><th>${r}</th>`;
    names.forEach((_,j)=>{
      h+=i===j?`<td></td>`:`<td><select class="cell" data-i="${i}" data-j="${j}">
      <option>0</option><option>+</option><option>-</option></select></td>`;
    });
    h+=`<td class="checkOK" id="c${i}"></td></tr>`;
  });

  h+=`</tbody></table>`;
  document.getElementById("tabla").innerHTML=h;
  document.querySelectorAll(".cell").forEach(c=>c.onchange=validar);
}

function validar(){
  let ok=true;
  document.querySelectorAll("#tablaVotos tbody tr").forEach((tr,i)=>{
    let p=0,n=0;
    tr.querySelectorAll("select").forEach(s=>{
      if(s.value==="+")p++;
      if(s.value==="-")n++;
    });
    document.getElementById("c"+i).textContent=(p===3&&n===3)?"‚úî":"";
    if(p!==3||n!==3)ok=false;
  });
  document.getElementById("btnRanking").disabled=!ok;
}

function procesar(){
  const labels=[...document.querySelectorAll("#tablaVotos thead th")]
    .slice(1,-1).map(th=>th.textContent);

  const stats=Object.fromEntries(labels.map(l=>[l,{p:0,n:0}]));

  document.querySelectorAll(".cell").forEach(c=>{
    const i=c.dataset.i,j=c.dataset.j;
    if(c.value==="+")stats[labels[j]].p++;
    if(c.value==="-")stats[labels[j]].n++;
  });

  const res=labels.map(l=>{
    const p=stats[l].p,n=stats[l].n;
    let rol="Aislado";
    if(p>=3&&n===0)rol="Lider";
    else if(n>=3&&p===0)rol="Rechazado";
    else if(p>0&&n>0)rol="Ambivalente";
    else if(p>=2&&n<2)rol="Integrado";
    return{l,p,n,rol};
  }).sort((a,b)=>b.p-a.p);

  let html=`<div class="roles-table" id="rankingBox"><h3>Ranking y roles</h3><table>
  <tr><th>Nombre</th><th>+</th><th>-</th><th>Rol</th></tr>`;
  res.forEach(r=>{
    html+=`<tr class="rol-${r.rol.toLowerCase()}"><td>${r.l}</td><td>${r.p}</td><td>${r.n}</td><td>${r.rol}</td></tr>`;
  });
  html+=`</table></div>`;
  document.getElementById("ranking").innerHTML=html;

  crearGrafico(res);
}

let chart;
function crearGrafico(res){
  if(chart)chart.destroy();
  const colores={
    Lider:"#4ade80",
    Rechazado:"#f87171",
    Aislado:"#94a3b8",
    Ambivalente:"#fde68a",
    Integrado:"#60a5fa"
  };

  chart=new Chart(document.getElementById("chart"),{
    type:"bar",
    data:{
      labels:res.map(r=>r.l),
      datasets:[{
        label:"Votos +",
        data:res.map(r=>r.p),
        backgroundColor:res.map(r=>colores[r.rol])
      },{
        label:"Votos -",
        data:res.map(r=>-r.n),
        backgroundColor:res.map(r=>colores[r.rol])
      }]
    },
    options:{
      animation:{duration:900,easing:"easeOutQuart"},
      plugins:{tooltip:{callbacks:{label:c=>Math.abs(c.parsed.y)}}},
      scales:{y:{ticks:{callback:v=>Math.abs(v)}}}
    }
  });
}

function exportar(id,name){
  html2canvas(document.getElementById(id)).then(c=>{
    const a=document.createElement("a");
    a.download=name+".png";
    a.href=c.toDataURL();
    a.click();
  });
}

function exportarCanvas(){
  const a=document.createElement("a");
  a.download="grafico_barras.png";
  a.href=document.getElementById("chart").toDataURL();
  a.click();
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sociograma — SOCIOMAP</title>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
body {
  margin: 0;
  padding: 32px;
  font-family: "Segoe UI", Arial, sans-serif;
  background: #0f172a;
  color: #fff;
  text-align: center;
}
h1 {
  font-size: 34px;
  margin-bottom: 4px;
}
.subtitle {
  font-size: 18px;
  color: #cbd5e1;
  margin-bottom: 24px;
}

#container {
  margin: auto;
  background: #ffffff;
  border-radius: 18px;
  padding: 16px;
  width: calc(100% - 40px);
  max-width: 1200px;
  box-shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
}

svg {
  width: 100%;
  height: 780px;
  background: #fff;
  border-radius: 10px;
}

.legend {
  margin-top: 18px;
  display: flex;
  justify-content: space-evenly;
  flex-wrap: wrap;
  font-size: 13px;
  color: #0f172a;
}

.legend .item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.legend .dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
}

.footer {
  margin-top: 28px;
  font-size: 14px;
  color: #0f172a;
}
.footer img {
  height: 48px;
  display: block;
  margin: auto;
}
.error {
  color: #b91c1c;
  font-size: 18px;
}
</style>
</head>

<body>

<h1>Sociograma Interactivo Académico</h1>
<div class="subtitle" id="infoGrupo"></div>

<div id="container">
  <div id="graph"></div>

  <div class="legend">
    <div class="item"><div class="dot" style="background:#22c55e"></div> Elección positiva (+)</div>
    <div class="item"><div class="dot" style="background:#ef4444"></div> Rechazo (–)</div>
    <div class="item"><div class="dot" style="background:#facc15"></div> Líder sociométrico</div>
    <div class="item"><div class="dot" style="background:#60a5fa"></div> Tamaño ∝ votos positivos</div>
  </div>

  <div class="footer">
    <img src="logo.png" alt="Logo Sociomap">
    SOCIOMAP · by Aranda Tools · 2026
  </div>
</div>

<script>
// Load data from sessionStorage
const labels = JSON.parse(sessionStorage.getItem("socio_labels") || "null");
const matrix = JSON.parse(sessionStorage.getItem("socio_matrix") || "null");
const grupo = sessionStorage.getItem("socio_grupo") || "";

if (!labels || !matrix) {
  document.getElementById("graph").innerHTML =
    `<div class="error">⚠️ No hay datos sociométricos válidos. Completa primero el formulario.</div>`;
  throw "Sin datos sociométricos";
}

// Show group + date
const fecha = new Date().toLocaleDateString("es-ES", {
  day:'numeric', month:'long', year:'numeric'
});
document.getElementById("infoGrupo").textContent =
  `Grupo: ${grupo || "Sin nombre"} — ${fecha}`;

// Process nodes and links
const nodes = labels.map((name, i) => {
  let pos = 0, neg = 0;
  matrix.forEach(r => {
    if (r[i] === "+") pos++;
    if (r[i] === "-") neg++;
  });
  return { id: i, name, pos, neg };
});

// Find leader (max +)
const leader = nodes.reduce((a, b) => b.pos > a.pos ? b : a, nodes[0]);

const links = [];
matrix.forEach((row, i) => {
  row.forEach((v, j) => {
    if (v === "+" || v === "-")
      links.push({ source:i, target:j, tipo:v });
  });
});

// D3 force simulation
const w = document.getElementById("container").clientWidth;
const h = 780;

const svg = d3.select("#graph")
  .append("svg")
  .attr("viewBox", `0 0 ${w} ${h}`);

// Define arc generator for curved edges
const curve = d3.linkRadial()
  .angle(d => d.angle)
  .radius(d => d.radius);

// Force layout
const simulation = d3.forceSimulation(nodes)
  .force("link", d3.forceLink(links)
    .id(d => d.id)
    .distance(160)
    .strength(0.9))
  .force("charge", d3.forceManyBody().strength(-550))
  .force("center", d3.forceCenter(w/2, h/2));

// Draw links
const link = svg.append("g")
  .selectAll("path")
  .data(links)
  .enter()
  .append("path")
  .attr("stroke", d => d.tipo === "+" ? "#22c55e" : "#ef4444")
  .attr("stroke-width", 2)
  .attr("fill", "none")
  .attr("stroke-dasharray", d => d.tipo === "-" ? "6,4" : "0");

// Draw nodes
const node = svg.append("g")
  .selectAll("g")
  .data(nodes)
  .enter()
  .append("g")
  .call(d3.drag()
    .on("start", dragStart)
    .on("drag", dragged)
    .on("end", dragEnd));

// Draw circles
node.append("circle")
  .attr("r", d => 28 + d.pos*3)   // size ∝ positive votes
  .attr("fill", d => d.id === leader.id ? "#facc15" : "#60a5fa")
  .attr("stroke", "#334155")
  .attr("stroke-width", 2);

// Labels under nodes
node.append("text")
  .text(d => `${d.name} (+${d.pos}/-${d.neg})`)
  .attr("text-anchor", "middle")
  .attr("dy", d => 28 + d.pos*3 + 14) // below circle
  .attr("font-size", "13px")
  .attr("fill", "#0f172a");

simulation.on("tick", () => {
  // straight link lines
  link.attr("d", d => {
    const dx = d.target.x - d.source.x;
    const dy = d.target.y - d.source.y;
    const dr = Math.sqrt(dx*dx + dy*dy) * 1.2; // curve radius
    return `M${d.source.x},${d.source.y}
            A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
  });

  node.attr("transform", d => `translate(${d.x},${d.y})`);
});

function dragStart(event, d) {
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x; d.fy = d.y;
}

function dragged(event, d) {
  d.fx = event.x; d.fy = event.y;
}

function dragEnd(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null; d.fy = null;
}
</script>

</body>
</html>







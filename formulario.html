<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulario SociomÃ©trico â€” SOCIOMAP</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  padding: 20px;
  background: #0f172a;
  color: #e2e8f0;
  font-family: "Segoe UI", Arial, sans-serif;
  text-align: center;
}
.container {
  max-width: 1000px;
  margin: auto;
  background: rgba(255, 255, 255, .05);
  padding: 26px;
  border-radius: 14px;
}
h1 { margin-bottom: 6px }
p { margin-top: 0; color: #cbd5e1 }

label { display: block; margin-top: 12px }
input, select {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  border-radius: 8px;
  font-size: 14px;
  box-sizing: border-box;
}

.checkbox-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-top: 12px;
}

.btn {
  padding: 9px 16px;
  border-radius: 8px;
  border: none;
  font-weight: bold;
  font-size: 14px;
  cursor: pointer;
  margin-top: 14px;
}
.btn-primary {
  background: #3b82f6;
  color: white;
}
.btn-primary:hover:enabled { background: #2563eb }
.btn-disabled {
  background: #475569;
  color: #cbd5e1;
  cursor: not-allowed;
  opacity: .6;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  border: 1px solid #475569;
  padding: 6px;
  text-align: center;
}
th {
  background: #1e293b;
  color: white;
}

.check-ok {
  color: #22c55e;
  font-weight: bold;
}

/* Ranking y grÃ¡fico */
.ranking-box, .grafico-box {
  display: none;
  background: white;
  color: black;
  border-radius: 12px;
  padding: 16px;
  margin-top: 24px;
}

/* Altura y responsividad del grÃ¡fico */
.grafico-box {
  width: 100%;
  max-width: 800px;
  margin: 24px auto 0;
}
.grafico-box canvas {
  width: 100% !important;
  height: 400px !important; /* Limita la altura aquÃ­ */
}

/* Colores por rol */
.role-lider { background: #dcfce7 }
.role-rechazado { background: #fee2e2 }
.role-aislado { background: #e5e7eb }
.role-ambivalente { background: #fef9c3 }
.role-integrado { background: #dbeafe }

/* BotÃ³n sociograma */
#btnSociograma {
  display: none;
}

/* Logo */
.logo {
  height: 64px;
  margin: 24px auto 0;
  display: block;
}

footer {
  margin-top: 10px;
  color: #94a3b8;
  font-size: 14px;
}
</style>
</head>

<body>
<div class="container">

<h1>Formulario SociomÃ©trico</h1>
<p>Completa la tabla con + / âˆ’ / 0. Cada fila debe tener exactamente 3 + y 3 âˆ’.</p>

<label>Nombre del grupo</label>
<input id="grupo" placeholder="Ej.: 3ÂºA, Equipo Verde">

<label>NÃºmero de participantes</label>
<select id="num">
  <option value="">-- Elige --</option>
</select>

<div class="checkbox-row">
  <input type="checkbox" id="custom">
  <label for="custom">Usar nombres personalizados</label>
</div>

<input id="names" placeholder="Ana, Juan, LucÃ­a..." style="display:none">

<button class="btn btn-primary" onclick="crearTabla()">Crear tabla</button>

<button id="btnRanking" class="btn btn-primary btn-disabled" disabled onclick="procesar()">
  Crear ranking
</button>

<div id="tabla"></div>

<div id="ranking" class="ranking-box"></div>

<div id="graficoBox" class="grafico-box">
  <h3>ðŸ“Š GrÃ¡fico de Barras SociomÃ©trico</h3>
  <canvas id="chart"></canvas>
</div>

<button id="btnSociograma" class="btn btn-primary" onclick="irASociograma()">
  CREAR SOCIOGRAMA
</button>

<img src="logo.png" class="logo" alt="SOCIOMAP">
<footer>Â© SOCIOMAP Â· ARANDA TOOLS 2026</footer>

</div>

<script>
const grupoInput = document.getElementById("grupo");
const numSelect = document.getElementById("num");
const customCheck = document.getElementById("custom");
const namesInput = document.getElementById("names");
const tablaDiv = document.getElementById("tabla");
const rankingDiv = document.getElementById("ranking");
const graficoBox = document.getElementById("graficoBox");
const btnRanking = document.getElementById("btnRanking");
const btnSociograma = document.getElementById("btnSociograma");
const chartCanvas = document.getElementById("chart");

let chart = null;

/* Participantes */
for (let i = 7; i <= 40; i++) {
  numSelect.innerHTML += `<option value="${i}">${i}</option>`;
}

customCheck.onchange = () => {
  namesInput.style.display = customCheck.checked ? "block" : "none";
};

/* Crear tabla */
function crearTabla() {
  const n = parseInt(numSelect.value);
  const grupo = grupoInput.value.trim();
  if (!n || !grupo) {
    alert("Debes indicar grupo y nÃºmero de participantes.");
    return;
  }
  localStorage.setItem("grupoNombre", grupo);

  let names = [];
  if (customCheck.checked) {
    names = namesInput.value.split(",").map(x => x.trim()).filter(x => x);
    if (names.length !== n) {
      alert("El nÃºmero de nombres no coincide.");
      return;
    }
  } else {
    for (let i = 1; i <= n; i++) names.push("P" + i);
  }

  let html = `<table id="tablaVotos"><thead><tr><th>De\\A</th>`;
  names.forEach(n => html += `<th>${n}</th>`);
  html += `<th>âœ”</th></tr></thead><tbody>`;

  names.forEach((from, i) => {
    html += `<tr><th>${from}</th>`;
    names.forEach((_, j) => {
      html += i === j ? `<td></td>` :
        `<td><select class="cell">
          <option>0</option><option>+</option><option>-</option>
        </select></td>`;
    });
    html += `<td id="check${i}" class="check-ok"></td></tr>`;
  });
  html += `</tbody></table>`;
  tablaDiv.innerHTML = html;

  document.querySelectorAll(".cell").forEach(c => c.onchange = validarTabla);
}

/* Validar */
function validarTabla() {
  let ok = true;
  document.querySelectorAll("#tablaVotos tbody tr").forEach((tr, i) => {
    let p = 0, n = 0;
    tr.querySelectorAll("select").forEach(s => {
      if (s.value === "+") p++;
      if (s.value === "-") n++;
    });
    document.getElementById("check" + i).textContent = (p === 3 && n === 3) ? "âœ”" : "";
    if (p !== 3 || n !== 3) ok = false;
  });

  if (ok) {
    btnRanking.disabled = false;
    btnRanking.classList.remove("btn-disabled");
  }
}

/* Procesar ranking + grÃ¡fico */
function procesar() {
  const headers = [...document.querySelectorAll("#tablaVotos thead th")]
    .slice(1, -1).map(th => th.textContent);

  let stats = {};
  headers.forEach(h => stats[h] = { p: 0, n: 0 });

  document.querySelectorAll(".cell").forEach((c, i) => {
    const j = i % headers.length;
    if (c.value === "+") stats[headers[j]].p++;
    if (c.value === "-") stats[headers[j]].n++;
  });

  const results = headers.map(h => {
    const { p, n } = stats[h];
    return { name: h, p, n, rol: calcularRol(p, n) };
  });

  let rh = `<table><tr><th>Nombre</th><th>+</th><th>-</th><th>Rol</th></tr>`;
  results.forEach(r => {
    rh += `<tr class="role-${r.rol.toLowerCase()}">
      <td>${r.name}</td><td>${r.p}</td><td>${r.n}</td><td>${r.rol}</td>
    </tr>`;
  });
  rh += `</table>`;
  rankingDiv.innerHTML = rh;
  rankingDiv.style.display = "block";

  graficoBox.style.display = "block";
  if (chart) chart.destroy();

  chart = new Chart(chartCanvas.getContext("2d"), {
    type: "bar",
    data: {
      labels: results.map(r => r.name),
      datasets: [
        { label: "Votos +", data: results.map(r => r.p), backgroundColor: "#22c55e" },
        { label: "Votos -", data: results.map(r => r.n), backgroundColor: "#ef4444" }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });

  localStorage.setItem("sociogramaData", JSON.stringify({
    nodes: results,
    links: results.flatMap((r, i) =>
      [...document.querySelectorAll(`#tablaVotos tbody tr:nth-child(${i + 1}) select`)]
        .map((s, j) => s.value !== "0" ? { source: r.name, target: headers[j], type: s.value } : null)
        .filter(x => x))
  }));

  btnSociograma.style.display = "inline-block";
}

/* Rol */
function calcularRol(p, n) {
  if (p > 3 && n <= 1) return "Lider";
  if (n > 3) return "Rechazado";
  if (p === 0) return "Aislado";
  if (p >= 2 && n >= 2) return "Ambivalente";
  return "Integrado";
}

function irASociograma() {
  window.location.href = "sociograma_interactivo.html";
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulario SociomÃ©trico â€” SOCIOMAP</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  body {
    background: #0f172a;
    color: #e2e8f0;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 20px;
  }
  .container {
    max-width: 1000px;
    margin:auto;
    background: rgba(255,255,255,0.05);
    padding: 28px;
    border-radius: 14px;
  }
  input, select {
    width:100%;
    padding:8px;
    font-size:14px;
    border-radius:8px;
    margin:6px 0;
  }
  .btn {
    padding:10px 16px;
    border-radius:8px;
    border:none;
    font-weight:bold;
    cursor:pointer;
    font-size:14px;
    margin-top:10px;
  }
  .btn-primary {
    background:#3b82f6;
    color:white;
  }
  .btn-disabled {
    background:#475569;
    color:#cbd5e1;
    cursor:not-allowed;
    opacity:0.6;
  }
  table {
    width:100%;
    border-collapse:collapse;
    margin-top:18px;
  }
  th, td {
    border:1px solid #475569;
    padding:6px;
  }
  th {
    background:#1e293b;
    color:white;
  }
  .checkOK {
    color:#22c55e;
    font-weight:bold;
  }
  .ranking-box, .grafico-box {
    background:white;
    color:black;
    border-radius:12px;
    padding:16px;
    margin-top:20px;
    display:none;
  }
  .export-row { margin-top:18px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;}
  .export-row .btn { font-size:13px; padding:7px 14px;}
  .fila-lider { background:#22c55e20; }
  .fila-rechazado { background:#ef444420; }
  .fila-aislado { background:#94a3b820; }
  .fila-ambivalente { background:#eab30820; }
  .fila-integrado { background:#3b82f620; }

  img.logo {
    height:64px;
    margin-top:24px;
    background:white;
    border-radius:12px;
    padding:4px 12px;
  }
  footer {margin-top:12px; color:#94a3b8; font-size:14px;}
</style>

</head>
<body>

<div class="container">

  <h1>Formulario SociomÃ©trico</h1>
  <p>Completa la tabla con + / âˆ’ / 0. Cada fila debe tener 3 + y 3 âˆ’.</p>

  <label>Nombre del grupo:</label>
  <input id="grupo" placeholder="Ej.: 3ÂºA, Equipo Verde...">

  <label>NÃºmero de participantes:</label>
  <select id="num">
    <option value="">-- Elige --</option>
  </select>

  <div style="margin-top:12px;display:flex;align-items:center;justify-content:center;gap:8px;">
    <input type="checkbox" id="custom">
    <label for="custom">Usar nombres personalizados</label>
  </div>

  <input id="names" placeholder="Ana, Juan, Pedro..." style="display:none;">

  <button class="btn btn-primary" id="btnCrearTabla" onclick="crearTabla()">Crear Tabla</button>

  <button class="btn btn-primary btn-disabled" id="btnCrearRanking" disabled onclick="procesar()">CREAR RANKING</button>

  <div class="export-row">
    <button class="btn btn-disabled" id="btnExportTabla" disabled onclick="exportar('tablaVotos','tabla_sociometrica')">Exportar Tabla a PNG</button>
    <button class="btn btn-disabled" id="btnExportRanking" disabled onclick="exportar('rankingBox','ranking_sociometrico')">Exportar Ranking a PNG</button>
  </div>

  <button class="btn btn-primary btn-disabled" id="btnCrearSociograma" disabled onclick="location.href='sociograma_web.html'">CREAR SOCIOGRAMA</button>

  <div id="tabla"></div>

  <div id="ranking" class="ranking-box"></div>

  <div id="graficoBox" class="grafico-box">
    <h3>ðŸ“Š GrÃ¡fico de barras sociomÃ©trico</h3>
    <canvas id="chart"></canvas>
  </div>

  <img src="logo.png" class="logo" alt="SOCIOMAP">
  <footer>Â© SOCIOMAP Â· ARANDA TOOLS 2026</footer>

</div>

<script>

const sel=document.getElementById("num");
for(let i=7;i<=40;i++) sel.innerHTML+=`<option value="${i}">${i}</option>`;

document.getElementById("custom").onchange = () => {
  document.getElementById("names").style.display = document.getElementById("custom").checked ? "block" : "none";
}

function habilitarBotones(){
  ["btnCrearRanking","btnExportTabla","btnExportRanking","btnCrearSociograma"].forEach(id => {
    const e=document.getElementById(id);
    e.disabled=false;
    e.classList.remove("btn-disabled");
  });
}

// crear tabla sociomÃ©trica
function crearTabla(){
  const n=document.getElementById("num").value;
  const grupo=document.getElementById("grupo").value.trim();
  if(!n) return alert("Debes elegir participantes.");
  if(!grupo) return alert("Debes indicar nombre del grupo.");

  localStorage.setItem("grupoNombre",grupo);

  let names=[];
  if(document.getElementById("custom").checked){
    names=document.getElementById("names").value.split(",").map(x=>x.trim()).filter(x=>x);
    if(names.length!=n) return alert("Debes poner exactamente "+n+" nombres.");
  } else {
    for(let i=1;i<=n;i++) names.push("P"+i);
  }

  let html=`<table id="tablaVotos"><thead><tr><th>De\\A</th>`;
  names.forEach(n=>html+=`<th>${n}</th>`);
  html+=`<th>âœ”</th></tr></thead><tbody>`;

  names.forEach((from,i)=>{
    html+=`<tr><th>${from}</th>`;
    names.forEach((to,j)=>{
      if(i===j) html+=`<td style="background:#1e293b;"></td>`;
      else html+=`<td><select class="cell"><option>0</option><option>+</option><option>-</option></select></td>`;
    });
    html+=`<td class="checkOK" id="c${i}"></td></tr>`;
  });

  html+=`</tbody></table>`;
  document.getElementById("tabla").innerHTML=html;

  document.querySelectorAll(".cell").forEach(c=>c.onchange=validarTabla);
}

// validar tabla sociomÃ©trica
function validarTabla(){
  let ok=true;
  document.querySelectorAll("#tablaVotos tbody tr").forEach((tr,i)=>{
    let p=0,n=0;
    tr.querySelectorAll("select").forEach(s=>{
      if(s.value==="+") p++;
      if(s.value==="-") n++;
    });
    document.getElementById("c"+i).textContent=(p===3 && n===3)?"âœ”":"";
    if(p!==3 || n!==3) ok=false;
  });
  if(ok) habilitarBotones();
}

// crear ranking
function procesar(){
  const labels=[...document.querySelectorAll("#tablaVotos thead th")].slice(1,-1).map(th=>th.textContent);

  // contar stats
  let stats={};
  labels.forEach(l=>stats[l]={p:0,n:0});

  document.querySelectorAll(".cell").forEach((c,idx)=>{
    const j=idx%labels.length;
    if(c.value==="+") stats[labels[j]].p++;
    if(c.value==="-") stats[labels[j]].n++;
  });

  const resultados=labels.map(l=>{
    const {p,n}=stats[l];
    let rol="Sin rol";
    if(p>3&&n<=1) rol="LÃ­der";
    else if(n>3) rol="Rechazado";
    else if(p===0) rol="Aislado";
    else if(p>=2&&n>=2) rol="Ambivalente";
    else if(p>=2&&n<=1) rol="Integrado";
    return {l,p,n,rol};
  }).sort((a,b)=>b.p-a.p);

  // tabla ranking
  let html=`<table><tr><th>Nombre</th><th>+</th><th>-</th><th>Rol</th></tr>`;
  resultados.forEach(r=>{
    html+=`<tr class="fila-${r.rol.toLowerCase()}"><td>${r.l}</td><td>${r.p}</td><td>${r.n}</td><td>${r.rol}</td></tr>`;
  });
  html+=`</table>`;
  document.getElementById("ranking").innerHTML=html;
  document.getElementById("ranking").style.display="block";

  // grÃ¡fico
  if(window.chart) window.chart.destroy();
  document.getElementById("graficoBox").style.display="block";
  window.chart=new Chart(document.getElementById("chart"), {
    type:"bar",
    data:{
      labels:resultados.map(r=>r.l),
      datasets:[
        {label:"Votos +",data:resultados.map(r=>r.p),backgroundColor:"#22c55e"},
        {label:"Votos -",data:resultados.map(r=>-r.n),backgroundColor:"#ef4444"}
      ]
    }
  });

  // guardar para sociograma
  localStorage.setItem("sociogramaData", JSON.stringify({
    nodes: resultados.map(r=>({
      name:r.l, votos:r.p, p:r.p, n:r.n, rol:r.rol
    })),
    links: resultados.flatMap((r,idx)=>
      [...document.querySelectorAll(`#tablaVotos tbody tr:nth-child(${idx+1}) select`)]
        .map((sel,j)=>sel.value!=="0" ? {source:r.l,target:labels[j],type:sel.value} : null)
        .filter(x=>x)
    )
  }));
}

// exportar
function exportar(id,name){
  html2canvas(document.getElementById(id)).then(canvas=>{
    const a=document.createElement("a");
    a.href=canvas.toDataURL();
    a.download=name+".png";
    a.click();
  });
}
</script>

</body>
</html>

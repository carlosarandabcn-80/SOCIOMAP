<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Formulario SociomÃ©trico â€” SOCIOMAP</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body {
      background: #0f172a;
      color: #e2e8f0;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      background: rgba(255, 255, 255, 0.05);
      padding: 28px;
      border-radius: 14px;
      animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 8px;
      font-size: 14px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background: #e2e8f0;
      color: #0f172a;
      font-weight: bold;
      cursor: pointer;
      transition: all .25s ease;
      font-size: 14px;
    }

    .btn:hover {
      background: #cbd5e1;
      transform: translateY(-1px);
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
      margin-top: 12px;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #475569;
      padding: 6px;
      text-align: center;
    }

    th {
      background: #1e293b;
    }

    .checkOK {
      color: #22c55e;
      font-weight: bold;
    }

    .grafico-box {
      background: white;
      padding: 18px;
      border-radius: 12px;
      margin-top: 22px;
      display: none;
    }

    .grafico-box h3 {
      color: #0f172a;
      font-size: 16px;
      margin-bottom: 6px;
    }

    .grafico-box p {
      color: #64748b;
      font-size: 13px;
    }

    .export-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 18px;
      flex-wrap: wrap;
    }

    .export-row .btn {
      font-size: 13px;
      padding: 7px 14px;
    }

    .hidden {
      display: none;
    }

    footer {
      margin-top: 14px;
      color: #94a3b8;
      font-size: 14px;
    }

    img.logo {
      height: 64px;
      background: white;
      border-radius: 12px;
      padding: 4px 12px;
      margin-top: 12px;
    }
  </style>
</head>

<body>
<div class="container">

  <h1>Formulario SociomÃ©trico</h1>
  <p>Introduce la tabla sociomÃ©trica (3 elecciones + y 3 rechazos âˆ’ por persona).</p>

  <label>Nombre del grupo</label>
  <input id="grupo" type="text" placeholder="Ej.: Taller A1" />

  <label>NÃºmero de participantes</label>
  <select id="num"></select>

  <label><input type="checkbox" id="custom"> Usar nombres personalizados</label>
  <input id="names" type="text" placeholder="Ana, Juan, LucÃ­a..." style="display:none;" />

  <!-- BOTÃ“N MOVIDO ABAJO -->
  <button class="btn btn-primary" id="btnTabla" onclick="crearTabla()">Crear tabla</button>

  <div id="tabla"></div>

  <!-- RANKING y GRAFICO OCULTOS POR DEFECTO -->
  <button class="btn btn-primary hidden" id="btnRanking" onclick="procesar()">Crear ranking</button>

  <div id="ranking" class="hidden"></div>

  <div class="grafico-box" id="graficoBox">
    <h3>ðŸ“Š GrÃ¡fico de barras sociomÃ©trico (interactivo)</h3>
    <canvas id="chart"></canvas>
    <p>ðŸ’¡ Pasa el cursor sobre las barras para ver los votos.</p>
  </div>

  <!-- EXPORTACIÃ“N -->
  <div class="export-row">
    <button class="btn" onclick="exportar('tablaVotos','tabla_sociometrica')">Exportar tabla</button>
    <button class="btn" onclick="exportar('ranking','ranking_roles')">Exportar ranking</button>
    <button class="btn" onclick="exportarCanvas()">Exportar grÃ¡fico</button>
  </div>

  <img src="logo.png" class="logo" alt="SOCIOMAP" />
  <footer>Â© SOCIOMAP Â· Aranda Tools</footer>
</div>

<script>
const num = document.getElementById("num");
for (let i = 7; i <= 40; i++) num.innerHTML += `<option>${i}</option>`;

document.getElementById("custom").onchange = e => {
  document.getElementById("names").style.display = e.target.checked ? "block" : "none";
};

function crearTabla() {
  const n = num.value;
  const custom = document.getElementById("custom").checked;
  let names = custom
    ? document.getElementById("names").value.split(",").map(x => x.trim())
    : Array.from({ length: n }, (_, i) => "P" + (i + 1));

  if (names.length !== +n) return alert("NÃºmero de nombres incorrecto");

  let h = `<table id="tablaVotos"><thead><tr><th>De\\A</th>`;
  names.forEach(x => h += `<th>${x}</th>`);
  h += `<th>âœ”</th></tr></thead><tbody>`;

  names.forEach((r, i) => {
    h += `<tr><th>${r}</th>`;
    names.forEach((_, j) => {
      h += i === j ? `<td></td>` : `<td><select class="cell" data-i="${i}" data-j="${j}">
      <option>0</option><option>+</option><option>-</option></select></td>`;
    });
    h += `<td class="checkOK" id="c${i}"></td></tr>`;
  });

  h += `</tbody></table>`;
  document.getElementById("tabla").innerHTML = h;

  document.querySelectorAll(".cell").forEach(c => c.onchange = validar);

  document.getElementById("btnRanking").classList.add("hidden");
  document.getElementById("ranking").classList.add("hidden");
  document.getElementById("graficoBox").style.display = "none";
}

function validar() {
  let ok = true;
  document.querySelectorAll("#tablaVotos tbody tr").forEach((tr, i) => {
    let p = 0, n = 0;
    tr.querySelectorAll("select").forEach(s => {
      if (s.value === "+") p++;
      if (s.value === "-") n++;
    });
    document.getElementById("c" + i).textContent = (p === 3 && n === 3) ? "âœ”" : "";
    if (p !== 3 || n !== 3) ok = false;
  });

  document.getElementById("btnRanking").classList.toggle("hidden", !ok);
}

function procesar() {
  const labels = [...document.querySelectorAll("#tablaVotos thead th")]
    .slice(1, -1).map(th => th.textContent);

  const stats = Object.fromEntries(labels.map(l => [l, { p: 0, n: 0 }]));

  document.querySelectorAll(".cell").forEach(c => {
    const i = c.dataset.i, j = c.dataset.j;
    if (c.value === "+") stats[labels[j]].p++;
    if (c.value === "-") stats[labels[j]].n++;
  });

  const res = labels.map(l => {
    const p = stats[l].p, n = stats[l].n;
    return { l, p, n };
  }).sort((a, b) => b.p - a.p);

  let html = `<div id="rankingBox"><table><tr><th>Nombre</th><th>+</th><th>-</th></tr>`;
  res.forEach(r => html += `<tr><td>${r.l}</td><td>${r.p}</td><td>${r.n}</td></tr>`);
  html += `</table></div>`;

  const rankingDiv = document.getElementById("ranking");
  rankingDiv.innerHTML = html;
  rankingDiv.classList.remove("hidden");

  crearGrafico(res);
}

let chart;
function crearGrafico(res) {
  if (chart) chart.destroy();
  const ctx = document.getElementById("chart").getContext("2d");
  document.getElementById("graficoBox").style.display = "block";

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: res.map(r => r.l),
      datasets: [
        {
          label: "Votos +",
          data: res.map(r => r.p),
          backgroundColor: "#22c55e"
        },
        {
          label: "Votos -",
          data: res.map(r => -r.n),
          backgroundColor: "#ef4444"
        }
      ]
    },
    options: {
      animation: {
        duration: 800,
        easing: "easeOutQuart"
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${Math.abs(ctx.parsed.y)}`
          }
        }
      },
      scales: {
        y: {
          ticks: {
            callback: v => Math.abs(v)
          }
        }
      }
    }
  });
}

function exportar(id, name) {
  const el = document.getElementById(id);
  html2canvas(el).then(canvas => {
    const a = document.createElement("a");
    a.href = canvas.toDataURL();
    a.download = `${name}.png`;
    a.click();
  });
}

function exportarCanvas() {
  const a = document.createElement("a");
  a.href = document.getElementById("chart").toDataURL();
  a.download = "grafico_sociometrico.png";
  a.click();
}
</script>
</body>
</html>

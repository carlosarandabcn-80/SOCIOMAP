<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sociograma — SOCIOMAP</title>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
body {
  margin: 0;
  padding: 32px;
  font-family: "Segoe UI", Arial, sans-serif;
  background: #0f172a;
  color: #fff;
  text-align: center;
}
h1 {
  font-size: 34px;
  margin-bottom: 2px;
}
.subtitle {
  font-size: 18px;
  color: #cbd5e1;
  margin-bottom: 22px;
}
#container {
  margin: auto;
  background: #ffffff;
  border-radius: 18px;
  padding: 20px;
  width: calc(100% - 40px);
  max-width: 1200px;
  box-shadow: 0 8px 28px rgba(0,0,0,0.35);
}
svg {
  width: 100%;
  height: 780px;
  background: #fff;
  border-radius: 10px;
}
legend {
  margin-top: 18px;
  display: flex;
  justify-content: space-evenly;
  flex-wrap: wrap;
  font-size: 13px;
  color: #0f172a;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
}
.legend-dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
}
.footer {
  margin-top: 26px;
  font-size: 14px;
  color: #0f172a;
}
.footer img {
  height: 48px;
  display: block;
  margin: auto;
}
.error {
  color: #b91c1c;
  font-size: 18px;
}
</style>

</head>
<body>

<h1>Sociograma Interactivo Académico</h1>
<div class="subtitle" id="infoGrupo"></div>

<div id="container">
  <div id="graph"></div>

  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div> Elección positiva (+)</div>
    <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div> Rechazo (−)</div>
    <div class="legend-item"><div class="legend-dot" style="background:#facc15"></div> Líder sociométrico</div>
    <div class="legend-item"><div class="legend-dot" style="background:#60a5fa"></div> Tamaño ∝ votos positivos</div>
  </div>

  <div class="footer">
    <img src="logo.png" alt="Logo SOCIOMAP">
    SOCIOMAP · by Aranda Tools · 2026
  </div>
</div>

<script>
// Load data
const labels = JSON.parse(sessionStorage.getItem("socio_labels") || "null");
const matrix = JSON.parse(sessionStorage.getItem("socio_matrix") || "null");
const grupo = sessionStorage.getItem("socio_grupo") || "";

if (!labels || !matrix) {
  document.getElementById("graph").innerHTML =
    `<div class="error">⚠️ No hay datos sociométricos válidos. Completa primero el formulario.</div>`;
  throw "No hay datos";
}

// group name + date
const fecha = new Date().toLocaleDateString("es-ES", {
  day:'numeric', month:'long', year:'numeric'
});
document.getElementById("infoGrupo").textContent =
  `Grupo: ${grupo || "Sin nombre"} — ${fecha}`;

// Compute node stats
const nodes = labels.map((name,i)=> {
  let pos=0, neg=0;
  matrix.forEach(r => {
    if (r[i]==="+") pos++;
    if (r[i]==="-") neg++;
  });
  return {id:i, name, pos, neg};
});

// leader = max positive
const leader = nodes.reduce((a,b) => b.pos > a.pos ? b : a, nodes[0]);

// Build links
const links = [];
matrix.forEach((row,i) => {
  row.forEach((v,j) => {
    if (v==="+"||v==="-") links.push({
      source: i, target: j, tipo: v
    });
  });
});

// circular layout
const w = document.getElementById("container").clientWidth;
const h = 780;
const centerX = w/2;
const centerY = h/2;
const R = Math.min(w,h)/3.4;

nodes.forEach((d,i) => {
  const angle = (i/nodes.length)*2*Math.PI - Math.PI/2;
  d.x = centerX + Math.cos(angle)*R;
  d.y = centerY + Math.sin(angle)*R;
});

// SVG
const svg = d3.select("#graph")
  .append("svg")
  .attr("viewBox", `0 0 ${w} ${h}`);

// draw links as arcs
const linkGroup = svg.append("g")
  .selectAll("path")
  .data(links)
  .enter()
  .append("path")
  .attr("fill","none")
  .attr("stroke",d=>d.tipo==="+"?"#22c55e":"#ef4444")
  .attr("stroke-width",2)
  .attr("stroke-dasharray",d=>d.tipo==="-"?"6,4":"0")
  .attr("d", d => {
    const sx = nodes[d.source].x;
    const sy = nodes[d.source].y;
    const tx = nodes[d.target].x;
    const ty = nodes[d.target].y;
    const dx = tx - sx;
    const dy = ty - sy;
    const dr = Math.sqrt(dx*dx + dy*dy) * 1.4;
    return `M ${sx},${sy}
            A ${dr},${dr} 0 0,1 ${tx},${ty}`;
  });

// draw nodes
const nodeG = svg.append("g")
  .selectAll("g")
  .data(nodes)
  .enter()
  .append("g")
  .attr("transform",d=>`translate(${d.x},${d.y})`);

// circles
nodeG.append("circle")
  .attr("r",d=>24 + d.pos*3)
  .attr("fill",d=>d.id===leader.id?"#facc15":"#60a5fa")
  .attr("stroke","#334155")
  .attr("stroke-width",2);

// labels
nodeG.append("text")
  .text(d => `${d.name}`)
  .attr("text-anchor","middle")
  .attr("dy",3)
  .attr("font-size","13px")
  .attr("font-weight","bold")
  .attr("fill","#0f172a");

// sub‑labels under
nodeG.append("text")
  .text(d => `+${d.pos}/-${d.neg}`)
  .attr("text-anchor","middle")
  .attr("dy", 18)
  .attr("font-size","12px")
  .attr("fill","#0f172a");

</script>

</body>
</html>






<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Calor Sociom√©trico</title>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #0f172a;
      color: #0f172a;
      text-align: center;
    }

    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 24px;
      background: #ffffff;
      border-radius: 14px;
    }

    h1 {
      margin-bottom: 4px;
    }

    p {
      margin-top: 0;
      color: #475569;
      font-size: 14px;
    }

    /* ====== TABLA ====== */
    .table-wrapper {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
    }

    th, td {
      border: 1px solid #e2e8f0;
      padding: 8px;
      text-align: center;
      font-size: 13px;
      min-width: 42px;
    }

    th {
      background: #f1f5f9;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    th:first-child {
      left: 0;
      z-index: 3;
    }

    td:first-child {
      background: #f8fafc;
      font-weight: bold;
      position: sticky;
      left: 0;
      z-index: 1;
    }

    /* ====== COLORES MAPA ====== */
    .heat-pos {
      background: #86efac;
      font-weight: bold;
    }

    .heat-neg {
      background: #fca5a5;
      font-weight: bold;
    }

    .heat-zero {
      background: #f8fafc;
      color: #94a3b8;
    }

    .diag {
      background: #e2e8f0;
    }

    td:hover {
      outline: 2px solid #2563eb;
      cursor: pointer;
    }

    /* ====== LEYENDA ====== */
    .legend {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 16px;
      flex-wrap: wrap;
      font-size: 14px;
    }

    .legend span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend i {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      display: inline-block;
    }

    /* ====== BOTONES ====== */
    .btn {
      margin-top: 24px;
      padding: 12px 22px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
    }

    .btn:hover {
      background: #2563eb;
    }

    footer {
      margin-top: 24px;
      font-size: 13px;
      color: #64748b;
    }

    .debug {
      margin-top: 12px;
      font-size: 12px;
      color: #64748b;
    }
  </style>
</head>

<body>

<div class="container">
  <h1>Mapa de Calor Sociom√©trico</h1>
  <p>Relaciones entre los participantes (emisor ‚Üí receptor)</p>

  <div id="heatmap" class="table-wrapper"></div>

  <div class="legend">
    <span><i style="background:#86efac;"></i> Relaci√≥n positiva (+)</span>
    <span><i style="background:#fca5a5;"></i> Relaci√≥n negativa (‚àí)</span>
    <span><i style="background:#f8fafc; border:1px solid #94a3b8;"></i> Sin relaci√≥n</span>
  </div>

  <button class="btn" onclick="window.location.href='Sociograma_web.html'">
    üîô Volver al Sociograma
  </button>

  <div class="debug" id="debug"></div>

  <footer>¬© SOCIOMAP ¬∑ Aranda Tools ¬∑ 2026</footer>
</div>

<script>
/* ===============================
   CARGA DE DATOS
================================ */

const data = JSON.parse(localStorage.getItem("sociogramaData"));

if (!data || !data.nodes || !data.links || data.nodes.length === 0) {
  document.getElementById("heatmap").innerHTML =
    "<p style='color:red;font-weight:bold;'>‚ùå No hay datos sociom√©tricos disponibles.</p>";
  throw new Error("Sin datos");
}

/* ===============================
   NOMBRES Y MATRIZ
================================ */

const names = data.nodes.map(n => n.name);
const size = names.length;

// Inicializar matriz
const matrix = Array.from({ length: size }, () =>
  Array.from({ length: size }, () => "0")
);

// Rellenar matriz (robusto)
data.links.forEach(link => {
  const source = typeof link.source === "string" ? link.source : link.source.name;
  const target = typeof link.target === "string" ? link.target : link.target.name;

  const i = names.indexOf(source);
  const j = names.indexOf(target);

  if (i !== -1 && j !== -1) {
    matrix[i][j] = link.type;
  }
});

/* ===============================
   CONSTRUIR TABLA
================================ */

let html = "<table><thead><tr><th>De \\ A</th>";
names.forEach(n => html += `<th>${n}</th>`);
html += "</tr></thead><tbody>";

matrix.forEach((row, i) => {
  html += `<tr><td>${names[i]}</td>`;
  row.forEach((val, j) => {
    if (i === j) {
      html += `<td class="diag"></td>`;
    } else if (val === "+") {
      html += `<td class="heat-pos">+</td>`;
    } else if (val === "-") {
      html += `<td class="heat-neg">‚àí</td>`;
    } else {
      html += `<td class="heat-zero">0</td>`;
    }
  });
  html += "</tr>";
});

html += "</tbody></table>";

document.getElementById("heatmap").innerHTML = html;
document.getElementById("debug").textContent =
  `‚úî Participantes: ${size} ¬∑ Relaciones registradas: ${data.links.length}`;
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Calor SociomÃ©trico</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f8fafc;
      color: #0f172a;
      text-align: center;
    }

    .container {
      max-width: 1300px;
      margin: 24px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.08);
    }

    h1 {
      margin-bottom: 2px;
      font-size: 28px;
      font-weight: bold;
    }

    p {
      margin-top: 0px;
      margin-bottom: 14px;
      color: #475569;
    }

    #heatmap {
      margin-top: 14px;
      border: 1px solid #ddd;
      overflow: hidden;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 14px;
      font-size: 14px;
    }
    .legend span {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend i {
      width: 20px;
      height: 12px;
      display: inline-block;
    }

    .btn {
      margin-top: 20px;
      padding: 12px 20px;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 15px;
      cursor: pointer;
    }
    .btn:hover {
      background: #2563eb;
    }

    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
    }

    footer {
      margin-top: 20px;
      font-size: 13px;
      color: #64748b;
    }
  </style>
</head>

<body>

<div class="container">
  <h1>Mapa de Calor SociomÃ©trico</h1>
  <p>Intensidad de relaciones sociomÃ©tricas (emisor â†’ receptor)</p>

  <div id="heatmap"></div>

  <div class="legend">
    <span><i style="background:#ef4444;"></i> Muy negativa</span>
    <span><i style="background:#fecaca;"></i> Negativa</span>
    <span><i style="background:#ffffff;border:1px solid #94a3b8;"></i> Sin relaciÃ³n</span>
    <span><i style="background:#a7f3d0;"></i> Positiva</span>
    <span><i style="background:#22c55e;"></i> Muy positiva</span>
  </div>

  <button class="btn" onclick="window.location.href='Sociograma_web.html'">
    ðŸ”™ Volver al Sociograma
  </button>

  <footer>Â© SOCIOMAP Â· Aranda Tools Â· 2026</footer>
</div>

<script>
  // Cargar datos desde localStorage
  const raw = JSON.parse(localStorage.getItem("sociogramaData"));
  if (!raw || !raw.nodes || !raw.links) {
    document.getElementById("heatmap").innerHTML =
      "<p style='color:red;'>No hay datos disponibles</p>";
    throw new Error("No data");
  }

  // Preparar nombres y matriz
  const names = raw.nodes.map(n => n.name);
  const size = names.length;

  const matrix = Array.from({length: size}, () => Array(size).fill(0));

  raw.links.forEach(l => {
    const source = typeof l.source === "string" ? l.source : l.source.name;
    const target = typeof l.target === "string" ? l.target : l.target.name;
    const i = names.indexOf(source);
    const j = names.indexOf(target);
    if (i >= 0 && j >= 0) {
      matrix[i][j] += (l.type === "+" ? 1 : -1);
    }
  });

  // Dimensiones
  const margin = {top: 100, right: 30, bottom: 80, left: 100};
  const width = Math.max(700, size * 40);
  const height = Math.max(700, size * 40);

  const svg = d3.select("#heatmap")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .call(d3.zoom().on("zoom", ({transform}) => {
      svgG.attr("transform", transform);
    }));

  const svgG = svg.append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  // Escala de colores
  const colorScale = d3.scaleLinear()
    .domain([-3, -1, 0, 1, 3])
    .range(["#b91c1c", "#fca5a5", "#ffffff", "#a7f3d0", "#15803d"]);

  // Escalas para ejes
  const x = d3.scaleBand().domain(names).range([0, width]).padding(0.03);
  const y = d3.scaleBand().domain(names).range([0, height]).padding(0.03);

  // Dibujar ejes
  svgG.append("g")
    .attr("transform", `translate(0, -5)`)
    .call(d3.axisTop(x))
    .selectAll("text")
      .attr("transform", "rotate(-45)")
      .style("text-anchor", "start");

  svgG.append("g")
    .call(d3.axisLeft(y));

  // Tooltip
  const tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip");

  // Dibujar celdas
  svgG.selectAll()
    .data(matrix.flatMap((row, i) => row.map((value, j) => ({i, j, value}))))
    .enter()
    .append("rect")
    .attr("x", d => x(names[d.j]))
    .attr("y", d => y(names[d.i]))
    .attr("width", x.bandwidth())
    .attr("height", y.bandwidth())
    .style("fill", d => colorScale(d.value))
    .style("stroke", "#ccc")
    .on("mouseover", function(event, d) {
      tooltip.transition().duration(100).style("opacity", 1);
      tooltip.html(
        `<strong>${names[d.i]} â†’ ${names[d.j]}</strong><br>` +
        `Valor: ${d.value}`
      )
      .style("left", (event.pageX + 10) + "px")
      .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", () => {
      tooltip.transition().duration(200).style("opacity", 0);
    });

</script>

</body>
</html>



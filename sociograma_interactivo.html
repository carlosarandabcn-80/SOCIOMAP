<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sociograma — SOCIOMAP</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 16px;
      text-align: center;
    }

    h1 {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .grupo-info {
      font-size: 15px;
      color: #94a3b8;
      margin-bottom: 32px;
    }

    #sociograma {
      background: white;
      border-radius: 16px;
      height: 700px;
      box-shadow: 0 6px 30px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .legend {
      margin-top: 30px;
      font-size: 14px;
      color: #cbd5e1;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .legend span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend i {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
    }

    footer {
      margin-top: 40px;
      font-size: 13px;
      color: #64748b;
    }

    svg {
      transition: transform 0.3s ease-in-out;
    }

    circle {
      transition: r 0.4s ease, fill 0.3s ease;
      cursor: pointer;
    }

    circle:hover {
      stroke: #0ea5e9;
      stroke-width: 3;
    }

    .label-name {
      fill: #ffffff;
      font-size: 13px;
      font-weight: 600;
      pointer-events: none;
    }

    .label-votes {
      fill: #0f172a;
      font-size: 12px;
      font-weight: 500;
      pointer-events: none;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>Sociograma Interactivo</h1>
  <div class="grupo-info" id="grupo-nombre"></div>

  <div id="sociograma"></div>

  <div class="legend">
    <span><i style="background:#22c55e;"></i> Vínculo positivo</span>
    <span><i style="background:#ef4444;"></i> Vínculo negativo</span>
    <span><i style="background:#facc15;"></i> Líder sociométrico</span>
    <span><i style="background:#60a5fa;"></i> Tamaño ∝ votos positivos</span>
  </div>

  <footer>© SOCIOMAP · Aranda Tools 2026</footer>
</div>

<script>
const rawData = JSON.parse(localStorage.getItem("sociogramaData") || "null");
const grupo = localStorage.getItem("grupoNombre") || "Grupo sin nombre";

if (!rawData || !rawData.nodes || !rawData.links) {
  document.body.innerHTML = "<h2 style='color:red;'>❌ No se encontraron datos sociométricos válidos.</h2><p>Por favor, regresa al formulario y genera el ranking.</p>";
  throw new Error("No data");
}

const labels = rawData.nodes.map(n => n.name);
const nodes = rawData.nodes.map((n, i) => ({
  id: i,
  name: n.name,
  votosPos: n.p,
  votosNeg: n.n
}));

const nodeMap = Object.fromEntries(labels.map((name, i) => [name, i]));
const links = rawData.links.map(l => ({
  source: nodeMap[l.source],
  target: nodeMap[l.target],
  type: l.type
}));

const liderIndex = nodes.reduce((a, c, i, arr) => c.votosPos > arr[a].votosPos ? i : a, 0);
document.getElementById("grupo-nombre").textContent =
  `Grupo: ${grupo} — ${new Date().toLocaleDateString("es-ES", { day:'numeric', month:'long', year:'numeric' })}`;

const width = document.getElementById("sociograma").clientWidth;
const height = 700;
const svg = d3.select("#sociograma").append("svg")
  .attr("width", width)
  .attr("height", height);

// Flechas (arrowheads)
svg.append("defs").selectAll("marker")
  .data(["pos", "neg"])
  .enter().append("marker")
    .attr("id", d => "arrow-" + d)
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 22)
    .attr("refY", 0)
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
  .append("path")
    .attr("d", "M0,-5L10,0L0,5")
    .attr("fill", d => d === "pos" ? "#22c55e" : "#ef4444");

const simulation = d3.forceSimulation(nodes)
  .force("link", d3.forceLink(links).id(d => d.id).distance(160))
  .force("charge", d3.forceManyBody().strength(-500))
  .force("center", d3.forceCenter(width / 2, height / 2));

const container = svg.append("g");

const link = container.append("g")
  .selectAll("path")
  .data(links)
  .enter().append("path")
    .attr("stroke", d => d.type === "+" ? "#22c55e" : "#ef4444")
    .attr("stroke-width", 2)
    .attr("fill", "none")
    .attr("stroke-dasharray", d => d.type === "-" ? "5,4" : "0")
    .attr("marker-end", d => `url(#arrow-${d.type === "+" ? "pos" : "neg"})`);

const node = container.append("g")
  .selectAll("g")
  .data(nodes)
  .enter().append("g")
    .call(d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended));

node.append("circle")
  .attr("r", 0)
  .attr("fill", d => d.id === liderIndex ? "#facc15" : "#60a5fa")
  .attr("stroke", "#0f172a")
  .attr("stroke-width", 2)
  .transition()
  .duration(800)
  .attr("r", d => 18 + d.votosPos * 2);

// Nombre del participante
node.append("text")
  .attr("class", "label-name")
  .attr("text-anchor", "middle")
  .attr("dy", 4)
  .text(d => d.name);

// Etiqueta de votos
node.append("text")
  .attr("class", "label-votes")
  .attr("text-anchor", "middle")
  .attr("dy", 26)
  .text(d => `+${d.votosPos} / −${d.votosNeg}`);

simulation.on("tick", () => {
  link.attr("d", d => {
    const dx = d.target.x - d.source.x;
    const dy = d.target.y - d.source.y;
    const dr = Math.sqrt(dx * dx + dy * dy);
    return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
  });

  node.attr("transform", d => `translate(${d.x},${d.y})`);
});

function dragstarted(event, d) {
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}
function dragged(event, d) {
  d.fx = event.x;
  d.fy = event.y;
}
function dragended(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}
</script>
</body>
</html>

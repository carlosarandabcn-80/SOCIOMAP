<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sociograma Interactivo — SOCIOMAP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://d3js.org/d3.v7.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:#0f172a;
  color:#fff;
  text-align:center;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:24px;
}
h1{font-size:28px;margin-bottom:4px}
h2{font-size:16px;color:#94a3b8;margin-top:8px;margin-bottom:18px}

#sociograma{
  background:white;
  height:680px;
  border-radius:18px;
  overflow:hidden;
}

.legend{
  margin-top:16px;
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  gap:20px;
  font-size:14px;
  color:white;
}
.legend span{
  display:flex;
  align-items:center;
  gap:6px;
}
.legend i{
  width:14px;
  height:14px;
  border-radius:50%;
}

.tooltip{
  position:absolute;
  background:#0f172a;
  color:white;
  padding:8px 14px;
  border-radius:8px;
  font-size:13px;
  pointer-events:none;
  box-shadow:0 6px 18px rgba(0,0,0,0.3);
  opacity:0;
  transition:.2s;
}

#interpretacion{
  margin-top:32px;
  padding:24px;
  background:white;
  color:#0f172a;
  text-align:left;
  border-radius:12px;
  line-height:1.65;
  box-shadow:0 8px 24px rgba(0,0,0,0.15);
}
#interpretacion h2{margin-top:0;font-size:20px;color:#111}
</style>
</head>

<body>
<div class="container">
  <h1>Sociograma Interactivo</h1>
  <h2 id="grupoInfo"></h2>

  <div id="sociograma"></div>

  <div class="legend">
    <span><i class="green" style="background:#22c55e"></i>Voto positivo emitido</span>
    <span><i class="red"   style="background:#ef4444"></i>Voto negativo emitido</span>
    <span><i class="yellow"style="background:#facc15"></i>Líder sociométrico</span>
    <span><i class="blue"  style="background:#60a5fa"></i>Tamaño = votos positivos recibidos</span>
  </div>

  <div id="interpretacion"></div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
// ——— Cargar datos de localStorage ———
let raw = localStorage.getItem("sociogramaData");
let data;
try{ data = raw ? JSON.parse(raw) : null; }
catch{ data = null; }

if(!data || !Array.isArray(data.nodes)){
  document.getElementById("sociograma").innerHTML = "<p style='padding:24px;color:red;'>No hay datos sociométricos válidos.</p>";
  throw new Error("Datos inválidos");
}

// Nombre grupo y fecha
const grupoNombre = localStorage.getItem("grupoNombre") || "Grupo sin nombre";
document.getElementById("grupoInfo").textContent = `${grupoNombre} — ${new Date().toLocaleDateString("es-ES",{day:'numeric',month:'long',year:'numeric'})}`;

// ——— Calcular votos recibidos y emitidos ———
data.nodes.forEach(n=>{
  n.recPos = 0;
  n.recNeg = 0;
  n.emitPos = 0;
  n.emitNeg = 0;
});

// Contar
data.links.forEach(l=>{
  const sourceNode = data.nodes.find(n=>n.name === l.source);
  const targetNode = data.nodes.find(n=>n.name === l.target);
  if(!sourceNode || !targetNode) return;

  if(l.type === "+"){
    sourceNode.emitPos++;
    targetNode.recPos++;
  } else {
    sourceNode.emitNeg++;
    targetNode.recNeg++;
  }
});

// Construir nodos y links D3
const nodes = data.nodes.map((n,i)=>({
  id: i,
  name: n.name,
  recPos: n.recPos,
  recNeg: n.recNeg,
  emitPos: n.emitPos,
  emitNeg: n.emitNeg,
  r: 22 + n.recPos * 3
}));

const indexMap = Object.fromEntries(nodes.map(n=>[n.name,n.id]));
const links = data.links.map(l=>({
  source: indexMap[l.source],
  target: indexMap[l.target],
  type: l.type
}));

// Quién es líder
const maxPos = Math.max(...nodes.map(n=>n.recPos));
nodes.forEach(n=> n.esLider = n.recPos === maxPos);

// ——— Crear D3 sociograma ———
const W = document.getElementById("sociograma").clientWidth;
const H = document.getElementById("sociograma").clientHeight;

const svg = d3.select("#sociograma").append("svg")
  .attr("width",W).attr("height",H);

const container = svg.append("g");

// Definir flechas
svg.append("defs").selectAll("marker")
  .data(["+","-"]).enter().append("marker")
  .attr("id",d=>"arr-"+(d==="+"?"pos":"neg"))
  .attr("viewBox","0 -5 10 10")
  .attr("refY",0)
  .attr("markerWidth",6).attr("markerHeight",6)
  .attr("orient","auto")
  .append("path")
  .attr("d","M0,-5L10,0L0,5")
  .attr("fill",d=> d==="+" ? "#22c55e" : "#ef4444");

// Dibujar enlaces
const link = container.append("g").selectAll("path")
  .data(links).enter().append("path")
  .attr("stroke", d=> d.type==="+"?"#22c55e":"#ef4444")
  .attr("stroke-width",2)
  .attr("fill","none")
  .attr("stroke-dasharray",d=> d.type==="-"?"6,4":"0")
  .attr("marker-end", d=>`url(#arr-${d.type==="+"?"pos":"neg"})`)
  .attr("opacity",0.15);

// Dibujar nodos
const node = container.append("g").selectAll("g")
  .data(nodes).enter().append("g")
  .call(d3.drag()
    .on("start", (event,d) => {
      if(!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x; d.fy = d.y;
    })
    .on("drag", (event,d) => { d.fx = event.x; d.fy = event.y; })
    .on("end", (event,d) => {
      if(!event.active) simulation.alphaTarget(0);
      d.fx = null; d.fy = null;
    })
  );

node.append("circle")
  .attr("r", d=>d.r)
  .attr("fill", d=> d.esLider ? "#facc15" : "#60a5fa")
  .attr("stroke","#0f172a").attr("stroke-width",2);

node.append("text")
  .text(d=>`${d.name}  +${d.emitPos} / -${d.emitNeg}`)
  .attr("text-anchor","middle")
  .attr("dy",4)
  .style("font-size","12px")
  .style("font-weight","600")
  .style("fill","#fff")
  .style("pointer-events","none");

const tooltip = d3.select("#tooltip");

node.on("mouseover",(event,d)=>{
  tooltip.style("opacity",1)
    .html(`<strong>${d.name}</strong><br>Votos positivos recibidos: ${d.recPos}<br>Votos negativos recibidos: ${d.recNeg}`);
})
.on("mousemove",(event)=>{
  tooltip.style("left",(event.pageX+14)+"px")
         .style("top",(event.pageY+14)+"px");
})
.on("mouseout",()=>tooltip.style("opacity",0));

// Simulación D3
const simulation = d3.forceSimulation(nodes)
  .force("link", d3.forceLink(links).id(d=>d.id).distance(170))
  .force("charge", d3.forceManyBody().strength(-750))
  .force("center", d3.forceCenter(W/2,H/2))
  .force("collision", d3.forceCollide().radius(d=>d.r+8));

simulation.on("tick",()=>{
  link.attr("d",d=>{
    const dx = d.target.x - d.source.x;
    const dy = d.target.y - d.source.y;
    const angle = Math.atan2(dy, dx);
    const tr = nodes[d.target.id].r + 4;
    return `M${d.source.x},${d.source.y} L${d.target.x - Math.cos(angle)*tr},${d.target.y - Math.sin(angle)*tr}`;
  });

  node.attr("transform",d=>`translate(${d.x},${d.y})`);
});

// ——— Interpretación automática IA ———
function generarInterpretacion(){
  let html = `<h2>Interpretación sociométrica del grupo</h2>`;
  html += `<p>El sociograma describe las relaciones sociales en función de votos positivos y negativos.</p>`;

  html += `<p>El liderazgo sociométrico recae en <strong>${nodes.find(n=>n.esLider).name}</strong>, quien recibió la máxima aceptación positiva (${maxPos} votos). Este tipo de posición suele reflejar reconocimiento social destacado.</p>`;

  const aislados = nodes.filter(n=>n.recPos===0 && n.recNeg===0);
  if(aislados.length){
    html += `<p>Se identifican perfiles aislados (${aislados.map(n=>n.name).join(", ")}), sin elecciones expresadas ni recibidas, lo cual sugiere baja visibilidad relacional.</p>`;
  }

  const periferia = nodes.filter(n=>n.recPos===0 && n.recNeg>0);
  if(periferia.length){
    html += `<p>Miembros en periferia (${periferia.map(n=>n.name).join(", ")}) presentan rechazo sin aceptación, lo cual indica posibles dificultades de integración.</p>`;
  }

  const ambivalentes = nodes.filter(n=>n.recPos>0 && n.recNeg>0);
  if(ambivalentes.length){
    html += `<p>Perfiles ambivalentes (${ambivalentes.map(n=>n.name).join(", ")}) reciben tanto aceptación como rechazo, señalando dinamismos relacionales mixtos.</p>`;
  }

  html += `<p>Desde una perspectiva socioeducativa, es recomendable potenciar dinámicas cooperativas, fortalecer la inclusión y atención a perfiles vulnerables, orientando la convivencia grupal hacia una mayor cohesión e integración.</p>`;

  return html;
}

document.getElementById("interpretacion").innerHTML = generarInterpretacion();
</script>
</body>
</html>

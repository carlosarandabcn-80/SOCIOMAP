<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sociograma Interactivo ‚Äî SOCIOMAP</title>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      text-align: center;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 16px;
    }

    h1 {
      font-size: 32px;
      margin-bottom: 4px;
    }

    .sub {
      font-size: 15px;
      color: #94a3b8;
      margin-bottom: 24px;
    }

    #sociograma {
      background: white;
      height: 680px;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 20px;
      flex-wrap: wrap;
      font-size: 14px;
    }

    .legend span {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #cbd5f5;
    }

    .legend i {
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }

    footer {
      margin-top: 36px;
      font-size: 13px;
      color: #64748b;
    }

    .tooltip {
      position: absolute;
      background: #0f172a;
      color: white;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 13px;
      pointer-events: none;
      box-shadow: 0 6px 20px rgba(0,0,0,.4);
      opacity: 0;
      transition: 0.2s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sociograma Interactivo</h1>
    <div class="sub" id="grupo"></div>

    <div id="sociograma"></div>

    <div class="legend">
      <span><i style="background:#22c55e;"></i>V√≠nculo positivo</span>
      <span><i style="background:#ef4444;"></i>V√≠nculo negativo</span>
      <span><i style="background:#facc15;"></i>L√≠der sociom√©trico</span>
      <span><i style="background:#60a5fa;"></i>Tama√±o ‚àù votos recibidos (+)</span>
    </div>

    <footer>¬© SOCIOMAP ¬∑ Aranda Tools 2026</footer>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script>
    const data = JSON.parse(localStorage.getItem("sociogramaData") || "null");
    const grupo = localStorage.getItem("grupoNombre") || "Grupo sin nombre";

    if (!data) {
      document.body.innerHTML = "<p style='color:red;padding:24px;'>‚ùå No hay datos sociom√©tricos disponibles.</p>";
      throw new Error("Faltan datos");
    }

    document.getElementById("grupo").textContent = `${grupo} ‚Äî ${new Date().toLocaleDateString("es-ES", {
      day: "numeric", month: "long", year: "numeric"
    })}`;

    const W = document.getElementById("sociograma").clientWidth;
    const H = 680;

    const svg = d3.select("#sociograma").append("svg")
      .attr("width", W)
      .attr("height", H);

    const container = svg.append("g");

    const nodes = data.nodes.map((n, i) => ({
      id: i,
      name: n.name,
      p: n.p,
      n: n.n,
      r: 18 + n.p * 2
    }));

    const indexMap = Object.fromEntries(nodes.map(n => [n.name, n.id]));

    const links = data.links.map(l => ({
      source: indexMap[l.source],
      target: indexMap[l.target],
      type: l.type
    }));

    const leader = nodes.reduce((a, b) => b.p > a.p ? b : a, nodes[0]).id;

    svg.append("defs").selectAll("marker")
      .data(["+","-"])
      .enter().append("marker")
        .attr("id", d => "arrow" + d)
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 10)
        .attr("refY", 0)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
      .append("path")
        .attr("d", "M0,-5L10,0L0,5")
        .attr("fill", d => d === "+" ? "#22c55e" : "#ef4444");

    const sim = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(links).id(d => d.id).distance(160))
      .force("charge", d3.forceManyBody().strength(-540))
      .force("center", d3.forceCenter(W / 2, H / 2))
      .force("collision", d3.forceCollide().radius(d => d.r + 6));

    const link = container.append("g")
      .selectAll("path")
      .data(links)
      .enter().append("path")
        .attr("stroke", d => d.type === "+" ? "#22c55e" : "#ef4444")
        .attr("stroke-width", 2)
        .attr("fill", "none")
        .attr("stroke-dasharray", d => d.type === "-" ? "6,4" : "0")
        .attr("marker-end", d => `url(#arrow${d.type})`)
        .attr("opacity", 0.85);

    const node = container.append("g")
      .selectAll("g")
      .data(nodes)
      .enter().append("g")
        .call(d3.drag()
          .on("start", dragstart)
          .on("drag", dragged)
          .on("end", dragend)
        );

    node.append("circle")
      .attr("r", 0)
      .attr("fill", d => d.id === leader ? "#facc15" : "#60a5fa")
      .attr("stroke", "#0f172a")
      .attr("stroke-width", 2)
      .transition()
      .duration(800)
      .ease(d3.easeBackOut)
      .attr("r", d => d.r);

    const tooltip = document.getElementById("tooltip");

    node.on("mouseenter", (event, d) => {
      tooltip.innerHTML = `<b>${d.name}</b><br>üëç ${d.p} ¬∑ üëé ${d.n}`;
      tooltip.style.opacity = 1;
      link.attr("opacity", l =>
        l.source.id === d.id || l.target.id === d.id ? 1 : 0.1
      );
    }).on("mousemove", event => {
      tooltip.style.left = event.pageX + 14 + "px";
      tooltip.style.top = event.pageY + 14 + "px";
    }).on("mouseleave", () => {
      tooltip.style.opacity = 0;
      link.attr("opacity", 0.85);
    });

    sim.on("tick", () => {
      link.attr("d", d => {
        const dx = d.target.x - d.source.x;
        const dy = d.target.y - d.source.y;
        const angle = Math.atan2(dy, dx);
        const targetR = nodes[d.target.id].r;
        const sx = d.source.x;
        const sy = d.source.y;
        const tx = d.target.x - Math.cos(angle) * (targetR + 2);
        const ty = d.target.y - Math.sin(angle) * (targetR + 2);
        return `M${sx},${sy} L${tx},${ty}`;
      });
      node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    svg.call(d3.zoom().scaleExtent([0.6, 2]).on("zoom", e => {
      container.attr("transform", e.transform);
    }));

    function dragstart(event, d) {
      if (!event.active) sim.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }

    function dragend(event, d) {
      if (!event.active) sim.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }
  </script>
</body>
</html>

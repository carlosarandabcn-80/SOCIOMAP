<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sociograma Interactivo</title>
  <script src="https://unpkg.com/force-graph"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #0c1222;
      color: #fff;
    }

    h1 {
      text-align: center;
      margin-top: 30px;
      font-size: 24px;
      font-weight: 600;
    }

    h2 {
      text-align: center;
      font-weight: 400;
      font-size: 14px;
      color: #ccc;
      margin-bottom: 10px;
    }

    #graph {
      width: 100%;
      height: 700px;
      margin: auto;
    }

    .legend {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
      font-size: 14px;
    }

    .legend div {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .green { background-color: #2ecc71; }
    .red { background-color: #e74c3c; }
    .blue { background-color: #3498db; }
    .yellow { background-color: #f1c40f; }

    .tooltip {
      position: absolute;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      font-size: 13px;
      border-radius: 6px;
      pointer-events: none;
      z-index: 10;
      display: none;
    }

    .interpretacion {
      max-width: 800px;
      margin: 40px auto;
      padding: 24px;
      background: #fff;
      color: #000;
      border-radius: 10px;
      line-height: 1.6;
    }

    .interpretacion h3 {
      font-size: 18px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <h1>Sociograma Interactivo</h1>
  <h2 id="grupoNombre"></h2>

  <div id="graph"></div>

  <div class="legend">
    <div><span class="dot green"></span> Voto positivo emitido</div>
    <div><span class="dot red"></span> Voto negativo emitido</div>
    <div><span class="dot yellow"></span> Líder sociométrico</div>
    <div><span class="dot blue"></span> Tamaño = votos positivos recibidos</div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <div class="interpretacion" id="interpretacion"></div>

  <script>
    const rawData = JSON.parse(localStorage.getItem('sociogramaData'));
    const grupo = localStorage.getItem('grupoNombre') || 'Grupo sin nombre';

    document.getElementById("grupoNombre").textContent = grupo + " — " + new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });

    const participantes = rawData.participantes;
    const matriz = rawData.matriz;

    const nodes = participantes.map((p, i) => ({
      id: `P${i + 1}`,
      index: i,
      name: `P${i + 1}`,
      votosPositivosRecibidos: 0,
      votosNegativosRecibidos: 0
    }));

    const links = [];

    for (let from = 0; from < matriz.length; from++) {
      for (let to = 0; to < matriz[from].length; to++) {
        const valor = matriz[from][to];
        if (valor === 1 || valor === -1) {
          const type = valor === 1 ? 'positivo' : 'negativo';
          links.push({
            source: `P${from + 1}`,
            target: `P${to + 1}`,
            type
          });
          if (valor === 1) {
            nodes[to].votosPositivosRecibidos++;
          } else {
            nodes[to].votosNegativosRecibidos++;
          }
        }
      }
    }

    // Detectar líder sociométrico
    const maxVotos = Math.max(...nodes.map(n => n.votosPositivosRecibidos));
    nodes.forEach(n => {
      n.esLider = n.votosPositivosRecibidos === maxVotos && maxVotos > 0;
    });

    // Tooltip
    const tooltip = document.getElementById("tooltip");
    function showTooltip(x, y, content) {
      tooltip.style.left = x + 10 + "px";
      tooltip.style.top = y + 10 + "px";
      tooltip.innerHTML = content;
      tooltip.style.display = "block";
    }

    function hideTooltip() {
      tooltip.style.display = "none";
    }

    const graph = ForceGraph()(document.getElementById('graph'))
      .graphData({ nodes, links })
      .nodeLabel(node => `${node.name}`)
      .nodeCanvasObject((node, ctx, globalScale) => {
        const label = `${node.name} +${node.votosPositivosRecibidos} / -${node.votosNegativosRecibidos}`;
        const fontSize = 12 / globalScale;
        const radius = 20 + node.votosPositivosRecibidos * 4;

        node.__radius = radius;

        ctx.beginPath();
        ctx.arc(node.x, node.y, radius, 0, 2 * Math.PI, false);
        ctx.fillStyle = node.esLider ? '#f1c40f' : '#3498db';
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#1a1a1a';
        ctx.stroke();

        ctx.font = `${fontSize}px Inter`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#fff';
        ctx.fillText(label, node.x, node.y);
      })
      .linkColor(link => link.type === 'positivo' ? '#2ecc71' : '#e74c3c')
      .linkDirectionalArrowColor(link => link.type === 'positivo' ? '#2ecc71' : '#e74c3c')
      .linkDirectionalArrowLength(6)
      .linkDirectionalArrowRelPos(1)
      .linkCurvature(0.25)
      .nodePointerAreaPaint((node, color, ctx) => {
        ctx.beginPath();
        ctx.arc(node.x, node.y, node.__radius + 4, 0, 2 * Math.PI, false);
        ctx.fillStyle = color;
        ctx.fill();
      })
      .onNodeHover((node, prevNode) => {
        if (node) {
          const html = `<strong>${node.name}</strong><br>Votos positivos recibidos: ${node.votosPositivosRecibidos}<br>Votos negativos recibidos: ${node.votosNegativosRecibidos}`;
          showTooltip(node.x, node.y, html);
        } else {
          hideTooltip();
        }
      })
      .d3Force('charge').strength(-200);

    // Interpretación IA automática
    function generarInterpretacion() {
      const lideres = nodes.filter(n => n.esLider).map(n => n.name);
      const perifericos = nodes.filter(n => n.votosPositivosRecibidos === 0);
      const rechazados = nodes.filter(n => n.votosNegativosRecibidos >= 3);
      const ambivalentes = nodes.filter(n =>
        n.votosPositivosRecibidos >= 2 && n.votosNegativosRecibidos >= 2
      );

      let texto = `<h3>Interpretación sociométrica del grupo</h3>`;
      texto += `<p>El análisis del sociograma muestra cómo los vínculos sociales del grupo se estructuran en torno a ciertos nodos clave.`;

      if (lideres.length > 0) {
        texto += ` El liderazgo sociométrico se encuentra representado por ${lideres.join(', ')}, quienes recibieron el mayor número de elecciones positivas, destacándose como figuras centrales con capacidad de influencia.`;
      }

      if (perifericos.length > 0) {
        texto += ` Por otro lado, se identifican miembros periféricos como ${perifericos.map(n => n.name).join(', ')}, que no recibieron votos positivos, lo que podría reflejar una situación de aislamiento o baja integración social.`;
      }

      if (rechazados.length > 0) {
        texto += ` Algunos participantes como ${rechazados.map(n => n.name).join(', ')} recibieron múltiples rechazos, siendo potencialmente objeto de rechazo grupal.`;
      }

      if (ambivalentes.length > 0) {
        texto += ` También se observa la presencia de participantes ambivalentes como ${ambivalentes.map(n => n.name).join(', ')}, que reciben tanto votos positivos como negativos. Esta ambivalencia puede deberse a posiciones intermedias de poder o a relaciones polarizadas.`;
      }

      texto += `</p><p>Desde la perspectiva de la intervención educativa, estos datos permiten visualizar dinámicas de aceptación, exclusión y liderazgo, proporcionando una base empírica para diseñar estrategias de mejora de la convivencia y cohesión grupal.</p>`;

      return texto;
    }

    document.getElementById("interpretacion").innerHTML = generarInterpretacion();
  </script>
</body>
</html>

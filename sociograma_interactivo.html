<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sociograma Interactivo</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: #0f172a;
      font-family: 'Inter', sans-serif;
      color: white;
      text-align: center;
    }
    h1 { margin: 12px 0 0; font-size: 24px; font-weight: 600; }
    h2 { font-size: 14px; font-weight: 400; color: #cbd5e1; margin: 0 0 16px; }

    #graph {
      width: 100%;
      height: 600px;
      background: white;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 24px;
      font-size: 14px;
      margin: 12px 0;
    }

    .legend span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend i {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: inline-block;
    }

    #tooltip {
      position: absolute;
      pointer-events: none;
      background: #0f172a;
      color: white;
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 6px;
      opacity: 0;
      box-shadow: 0 6px 18px rgba(0,0,0,0.3);
      transition: .2s ease;
    }

    #interpretacion {
      background: white;
      color: #1e293b;
      padding: 24px;
      max-width: 900px;
      margin: 32px auto;
      border-radius: 12px;
      text-align: left;
      line-height: 1.65;
    }

    #interpretacion h3 {
      margin-top: 0;
    }
  </style>
</head>
<body>

  <h1>Sociograma Interactivo</h1>
  <h2>Grupo de ejemplo — Fecha de ejemplo</h2>

  <div id="graph"></div>

  <div class="legend">
    <span><i style="background:#22c55e;"></i> Voto positivo emitido</span>
    <span><i style="background:#ef4444;"></i> Voto negativo emitido</span>
    <span><i style="background:#facc15;"></i> Líder sociométrico</span>
    <span><i style="background:#60a5fa;"></i> Tamaño = votos positivos recibidos</span>
  </div>

  <div id="tooltip"></div>

  <div id="interpretacion"></div>

  <script>
    // Simulación de datos del formulario
    const participantes = ["P1","P2","P3","P4","P5","P6","P7"];

    const links = [
      // Cada participante emite 3 positivos y 3 negativos
      {source:"P1",target:"P2",type:"+"}, {source:"P1",target:"P3",type:"+"}, {source:"P1",target:"P5",type:"+"},
      {source:"P1",target:"P4",type:"-"}, {source:"P1",target:"P6",type:"-"}, {source:"P1",target:"P7",type:"-"},
      
      {source:"P2",target:"P1",type:"+"}, {source:"P2",target:"P3",type:"+"}, {source:"P2",target:"P4",type:"+"},
      {source:"P2",target:"P5",type:"-"}, {source:"P2",target:"P6",type:"-"}, {source:"P2",target:"P7",type:"-"},
      
      {source:"P3",target:"P1",type:"+"}, {source:"P3",target:"P2",type:"+"}, {source:"P3",target:"P6",type:"+"},
      {source:"P3",target:"P4",type:"-"}, {source:"P3",target:"P5",type:"-"}, {source:"P3",target:"P7",type:"-"},
      
      {source:"P4",target:"P1",type:"+"}, {source:"P4",target:"P2",type:"+"}, {source:"P4",target:"P3",type:"+"},
      {source:"P4",target:"P5",type:"-"}, {source:"P4",target:"P6",type:"-"}, {source:"P4",target:"P7",type:"-"},
      
      {source:"P5",target:"P1",type:"+"}, {source:"P5",target:"P3",type:"+"}, {source:"P5",target:"P6",type:"+"},
      {source:"P5",target:"P2",type:"-"}, {source:"P5",target:"P4",type:"-"}, {source:"P5",target:"P7",type:"-"},
      
      {source:"P6",target:"P1",type:"+"}, {source:"P6",target:"P2",type:"+"}, {source:"P6",target:"P3",type:"+"},
      {source:"P6",target:"P4",type:"-"}, {source:"P6",target:"P5",type:"-"}, {source:"P6",target:"P7",type:"-"},
      
      {source:"P7",target:"P1",type:"+"}, {source:"P7",target:"P2",type:"+"}, {source:"P7",target:"P4",type:"+"},
      {source:"P7",target:"P3",type:"-"}, {source:"P7",target:"P5",type:"-"}, {source:"P7",target:"P6",type:"-"}
    ];

    const nodes = participantes.map(name => ({
      id: name,
      name,
      recPos: 0,
      recNeg: 0,
      emitPos: 0,
      emitNeg: 0
    }));

    // Cálculo de votos
    links.forEach(link => {
      const from = nodes.find(n => n.name === link.source);
      const to = nodes.find(n => n.name === link.target);
      if (link.type === "+") {
        from.emitPos++;
        to.recPos++;
      } else {
        from.emitNeg++;
        to.recNeg++;
      }
    });

    const maxRec = Math.max(...nodes.map(n=>n.recPos));
    nodes.forEach(n => {
      n.radius = 20 + n.recPos * 4;
      n.color = n.recPos === maxRec ? "#facc15" : "#60a5fa";
    });

    // Crear sociograma
    const width = document.getElementById("graph").clientWidth;
    const height = document.getElementById("graph").clientHeight;

    const svg = d3.select("#graph").append("svg")
      .attr("width", width)
      .attr("height", height);

    const marker = svg.append("defs").selectAll("marker")
      .data(["pos","neg"])
      .enter()
      .append("marker")
      .attr("id", d => `arrow-${d}`)
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 20)
      .attr("refY", 0)
      .attr("markerWidth", 6)
      .attr("markerHeight", 6)
      .attr("orient", "auto")
      .append("path")
      .attr("d", "M0,-5L10,0L0,5")
      .attr("fill", d => d === "pos" ? "#22c55e" : "#ef4444");

    const link = svg.append("g")
      .selectAll("path")
      .data(links)
      .enter()
      .append("path")
      .attr("stroke", d => d.type === "+" ? "#22c55e" : "#ef4444")
      .attr("stroke-width", 2)
      .attr("stroke-dasharray", d => d.type === "-" ? "4,4" : "0")
      .attr("fill", "none")
      .attr("marker-end", d => `url(#arrow-${d.type === "+" ? "pos" : "neg"})`)
      .attr("opacity", 0.6);

    const node = svg.selectAll("g.node")
      .data(nodes)
      .enter()
      .append("g")
      .attr("class", "node")
      .call(d3.drag()
        .on("start", (event, d) => {
          if (!event.active) sim.alphaTarget(0.3).restart();
          d.fx = d.x; d.fy = d.y;
        })
        .on("drag", (event,d) => {
          d.fx = event.x; d.fy = event.y;
        })
        .on("end", (event,d) => {
          if (!event.active) sim.alphaTarget(0);
          d.fx = null; d.fy = null;
        })
      );

    node.append("circle")
      .attr("r", d => d.radius)
      .attr("fill", d => d.color)
      .attr("stroke", "#1e293b")
      .attr("stroke-width", 2);

    node.append("text")
      .attr("text-anchor", "middle")
      .attr("dy", 4)
      .attr("fill", "#fff")
      .style("font-size", "12px")
      .text(d => `${d.name} +${d.emitPos}/-${d.emitNeg}`);

    const tooltip = d3.select("#tooltip");

    node.on("mouseover", (event, d) => {
      tooltip
        .style("opacity", 1)
        .html(`<strong>${d.name}</strong><br>Votos positivos recibidos: ${d.recPos}<br>Votos negativos recibidos: ${d.recNeg}`);
    }).on("mousemove", (event) => {
      tooltip.style("left", (event.pageX + 14) + "px").style("top", (event.pageY + 14) + "px");
    }).on("mouseout", () => {
      tooltip.style("opacity", 0);
    });

    const sim = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(links).id(d => d.name).distance(140))
      .force("charge", d3.forceManyBody().strength(-700))
      .force("center", d3.forceCenter(width / 2, height / 2))
      .force("collide", d3.forceCollide().radius(d => d.radius + 10));

    sim.on("tick", () => {
      link.attr("d", d => `M${d.source.x},${d.source.y}L${d.target.x},${d.target.y}`);
      node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    // Interpretación automática
    const interpretacion = () => {
      const lider = nodes.find(n => n.recPos === maxRec)?.name;
      const aislados = nodes.filter(n => n.recPos === 0 && n.recNeg === 0).map(n => n.name);
      const periferia = nodes.filter(n => n.recPos === 0 && n.recNeg > 0).map(n => n.name);
      const ambivalentes = nodes.filter(n => n.recPos > 0 && n.recNeg > 0).map(n => n.name);

      let html = `<h3>Interpretación sociométrica del grupo</h3>`;
      html += `<p>El líder sociométrico es <strong>${lider}</strong>, quien ha recibido el mayor número de votos positivos, reflejando centralidad e influencia positiva dentro del grupo.</p>`;
      if (aislados.length) html += `<p><strong>Miembros aislados:</strong> ${aislados.join(", ")}. Estos miembros no reciben votos y pueden requerir atención socioeducativa específica.</p>`;
      if (periferia.length) html += `<p><strong>Periferia:</strong> ${periferia.join(", ")}. Reciben rechazo sin aceptación, lo que puede indicar riesgo de exclusión.</p>`;
      if (ambivalentes.length) html += `<p><strong>Ambivalentes:</strong> ${ambivalentes.join(", ")}. Presentan vínculos contradictorios (aceptación y rechazo), lo que puede reflejar posiciones inestables o polarizantes.</p>`;
      html += `<p>Este análisis permite a profesionales en educación social diseñar estrategias de intervención para fortalecer la cohesión del grupo y prevenir dinámicas de exclusión.</p>`;
      return html;
    }

    document.getElementById("interpretacion").innerHTML = interpretacion();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sociograma Interactivo · SOCIOMAP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://d3js.org/d3.v7.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  background:#0f172a;
  font-family:'Inter',sans-serif;
  color:#fff;
  text-align:center;
}
h1{margin-top:24px;font-size:26px}
h2{font-size:15px;color:#94a3b8;margin:6px 0 18px}

#graph{
  width:100%;
  height:720px;
  background:#ffffff;
  border-radius:16px;
  box-shadow:0 18px 50px rgba(0,0,0,.25);
}

.legend{
  display:flex;
  justify-content:center;
  gap:24px;
  font-size:14px;
  margin:14px 0;
}
.legend span{display:flex;align-items:center;gap:6px}
.legend i{width:14px;height:14px;border-radius:50%}

.tooltip{
  position:absolute;
  background:#020617;
  color:white;
  padding:10px 14px;
  font-size:13px;
  border-radius:10px;
  pointer-events:none;
  opacity:0;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}

#interpretacion{
  margin:34px auto;
  padding:30px;
  background:#ffffff;
  border-radius:16px;
  max-width:900px;
  text-align:left;
  color:#0f172a;
  line-height:1.7;
  box-shadow:0 12px 36px rgba(0,0,0,.18);
}
#interpretacion h3{margin-top:0}
</style>
</head>

<body>

<h1>Sociograma Interactivo</h1>
<h2 id="grupoInfo"></h2>

<div id="graph"></div>

<div class="legend">
  <span><i style="background:#22c55e"></i>Voto positivo emitido</span>
  <span><i style="background:#ef4444"></i>Voto negativo emitido</span>
  <span><i style="background:#facc15"></i>Líder sociométrico</span>
  <span><i style="background:#60a5fa"></i>Tamaño = votos positivos recibidos</span>
</div>

<div class="tooltip" id="tooltip"></div>
<div id="interpretacion"></div>

<script>
/* =========================
   CARGA DE DATOS REALES
========================= */
const raw = localStorage.getItem("sociogramaData");
if(!raw){
  document.getElementById("graph").innerHTML =
    "<p style='padding:24px;color:red;font-size:18px'>No hay datos sociométricos.</p>";
  throw "";
}

const data = JSON.parse(raw);
const grupo = localStorage.getItem("grupoNombre") || "Grupo sin nombre";
document.getElementById("grupoInfo").textContent =
  `${grupo} — ${new Date().toLocaleDateString("es-ES",{day:'numeric',month:'long',year:'numeric'})}`;

/* =========================
   PROCESAR NODOS Y VOTOS
========================= */
data.nodes.forEach(n=>{
  n.recPos=0; n.recNeg=0;
});

data.links.forEach(l=>{
  const target = data.nodes.find(n=>n.name===l.target);
  if(l.type==="+") target.recPos++;
  else target.recNeg++;
});

const maxPos = Math.max(...data.nodes.map(n=>n.recPos));

const nodes = data.nodes.map((n,i)=>({
  id:i,
  name:n.name,
  recPos:n.recPos,
  recNeg:n.recNeg,
  radius:22 + n.recPos*4,
  leader: n.recPos===maxPos
}));

const index = Object.fromEntries(nodes.map(n=>[n.name,n.id]));

const links = data.links.map((l,i)=>({
  source:index[l.source],
  target:index[l.target],
  type:l.type,
  curve: (i%2?1:-1)*(40 + (i%3)*20)
}));

/* =========================
   D3 SETUP
========================= */
const width = document.getElementById("graph").clientWidth;
const height = document.getElementById("graph").clientHeight;

const svg = d3.select("#graph").append("svg")
  .attr("width",width)
  .attr("height",height);

const g = svg.append("g");

/* Flechas */
const defs = svg.append("defs");
["pos","neg"].forEach(t=>{
  defs.append("marker")
    .attr("id","arrow-"+t)
    .attr("viewBox","0 -5 10 10")
    .attr("refX",28)
    .attr("refY",0)
    .attr("markerWidth",7)
    .attr("markerHeight",7)
    .attr("orient","auto")
    .append("path")
    .attr("d","M0,-5L10,0L0,5")
    .attr("fill",t==="pos"?"#22c55e":"#ef4444");
});

/* Enlaces */
const link = g.append("g")
  .selectAll("path")
  .data(links)
  .enter().append("path")
  .attr("stroke",d=>d.type==="+"?"#22c55e":"#ef4444")
  .attr("stroke-width",3.2)
  .attr("fill","none")
  .attr("stroke-dasharray",d=>d.type==="-"?"7,5":"0")
  .attr("marker-end",d=>"url(#arrow-"+(d.type==="+"?"pos":"neg")+")");

/* Nodos */
const node = g.append("g")
  .selectAll("g")
  .data(nodes)
  .enter().append("g")
  .call(d3.drag()
    .on("start",(e,d)=>{ if(!e.active) sim.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; })
    .on("drag",(e,d)=>{ d.fx=e.x; d.fy=e.y; })
    .on("end",(e,d)=>{ if(!e.active) sim.alphaTarget(0); d.fx=null; d.fy=null; })
  );

node.append("circle")
  .attr("r",d=>d.radius)
  .attr("fill",d=>d.leader?"#facc15":"#60a5fa")
  .attr("stroke","#0f172a")
  .attr("stroke-width",2);

node.append("text")
  .text(d=>d.name)
  .attr("text-anchor","middle")
  .attr("dy",4)
  .style("font-weight","600")
  .style("fill","#fff");

/* Tooltip */
const tooltip = d3.select("#tooltip");
node.on("mouseover",(e,d)=>{
  tooltip.style("opacity",1)
    .html(`<strong>${d.name}</strong><br>
    Votos positivos recibidos: ${d.recPos}<br>
    Votos negativos recibidos: ${d.recNeg}`);
})
.on("mousemove",e=>{
  tooltip.style("left",(e.pageX+16)+"px")
         .style("top",(e.pageY+16)+"px");
})
.on("mouseout",()=>tooltip.style("opacity",0));

/* Simulación */
const sim = d3.forceSimulation(nodes)
  .force("link", d3.forceLink(links).id(d=>d.id).distance(170).strength(1))
  .force("charge", d3.forceManyBody().strength(-950))
  .force("center", d3.forceCenter(width/2,height/2))
  .force("collision", d3.forceCollide().radius(d=>d.radius+10));

sim.on("tick",()=>{
  link.attr("d",d=>{
    const dx=d.target.x-d.source.x;
    const dy=d.target.y-d.source.y;
    const dr=Math.sqrt(dx*dx+dy*dy)*1.2;
    return `M${d.source.x},${d.source.y}
            A${dr},${dr} 0 0,${d.curve>0?1:0}
            ${d.target.x},${d.target.y}`;
  });
  node.attr("transform",d=>`translate(${d.x},${d.y})`);
});

/* Zoom centrado */
svg.call(
  d3.zoom().scaleExtent([0.5,2.5])
  .on("zoom",e=>g.attr("transform",e.transform))
);

/* =========================
   INTERPRETACIÓN AUTOMÁTICA
========================= */
function interpretar(){
  const lider = nodes.find(n=>n.leader).name;
  const aislados = nodes.filter(n=>n.recPos===0 && n.recNeg===0).map(n=>n.name);
  const periferia = nodes.filter(n=>n.recPos===0 && n.recNeg>0).map(n=>n.name);
  const ambivalentes = nodes.filter(n=>n.recPos>0 && n.recNeg>0).map(n=>n.name);

  let t = `<h3>Interpretación sociométrica del grupo</h3>`;
  t += `<p>El análisis revela un liderazgo claro ejercido por <strong>${lider}</strong>, caracterizado por una alta recepción de elecciones positivas, indicador de centralidad y reconocimiento social.</p>`;
  if(aislados.length)
    t+=`<p>Se identifican miembros aislados (${aislados.join(", ")}), sin vínculos significativos, lo que puede implicar riesgo de desvinculación social.</p>`;
  if(periferia.length)
    t+=`<p>La periferia del grupo está formada por ${periferia.join(", ")}, con predominio de rechazo y ausencia de aceptación.</p>`;
  if(ambivalentes.length)
    t+=`<p>Los miembros ambivalentes (${ambivalentes.join(", ")}) reciben simultáneamente aceptación y rechazo, reflejando posiciones sociales inestables.</p>`;
  t+=`<p>Desde una perspectiva socioeducativa, estos patrones son consistentes con modelos clásicos de sociometría (Moreno) y permiten orientar intervenciones para reforzar cohesión y prevenir exclusión.</p>`;
  return t;
}

document.getElementById("interpretacion").innerHTML = interpretar();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sociograma Interactivo</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      background-color: #0b132b;
      font-family: 'Segoe UI', sans-serif;
      color: #111;
      margin: 0;
      padding: 2rem;
    }
    h1, h2 {
      color: #fff;
      text-align: center;
      margin: 0;
    }
    #sociograma {
      background: white;
      height: 700px;
      border-radius: 18px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
      overflow: hidden;
      position: relative;
      margin-top: 2rem;
    }
    .legend {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: 1rem;
      color: #fff;
      font-size: 0.9rem;
    }
    .legend div {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .circle {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }
    .green { background: #2ecc71; }
    .red { background: #e74c3c; }
    .yellow { background: #f1c40f; }
    .blue { background: #3498db; }

    .tooltip {
      position: absolute;
      background-color: #0b132b;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      pointer-events: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      z-index: 10;
      display: none;
    }

    #interpretacion {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      margin-top: 2rem;
      box-shadow: 0 0 20px rgba(0,0,0,0.15);
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    #interpretacion h2 {
      color: #0b132b;
      font-size: 20px;
      margin-bottom: 1rem;
    }

    #interpretacion p {
      font-size: 16px;
      line-height: 1.6;
      color: #222;
    }
  </style>
</head>
<body>
  <h1>Sociograma Interactivo</h1>
  <h2 id="grupoInfo">Grupo</h2>
  <div id="sociograma"></div>
  <div class="legend">
    <div><span class="circle green"></span>Voto positivo emitido</div>
    <div><span class="circle red"></span>Voto negativo recibido</div>
    <div><span class="circle yellow"></span>Líder sociométrico</div>
    <div><span class="circle blue"></span>Tamaño = votos positivos recibidos</div>
  </div>
  <div id="interpretacion">
    <h2>Interpretación sociométrica del grupo</h2>
    <p id="textoInterpretacion">Cargando análisis...</p>
  </div>

  <script>
    const data = JSON.parse(localStorage.getItem('sociogramaData'));
    const grupo = localStorage.getItem('grupoNombre') || 'Sin nombre';

    const W = 900;
    const H = 650;

    document.getElementById("grupoInfo").innerText = grupo;

    const nodes = [];
    const links = [];

    const votosRecibidosPos = Array(data.length).fill(0);
    const votosRecibidosNeg = Array(data.length).fill(0);

    data.forEach((row, sourceIndex) => {
      row.forEach((voto, targetIndex) => {
        if (voto === 1) {
          links.push({ source: sourceIndex, target: targetIndex, tipo: 'positivo' });
          votosRecibidosPos[targetIndex]++;
        } else if (voto === -1) {
          links.push({ source: targetIndex, target: sourceIndex, tipo: 'negativo' });
          votosRecibidosNeg[sourceIndex]++;
        }
      });
    });

    data.forEach((_, i) => {
      nodes.push({
        id: i,
        nombre: `P${i + 1}`,
        recPos: votosRecibidosPos[i],
        recNeg: votosRecibidosNeg[i],
        r: 25 + votosRecibidosPos[i] * 4
      });
    });

    const maxPos = Math.max(...votosRecibidosPos);
    const liderIndex = votosRecibidosPos.indexOf(maxPos);

    const svg = d3.select("#sociograma").append("svg")
      .attr("width", W)
      .attr("height", H);

    const tooltip = d3.select("body").append("div")
      .attr("class", "tooltip");

    const simulation = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(links).distance(200).strength(1).id(d => d.id))
      .force("charge", d3.forceManyBody().strength(-600))
      .force("center", d3.forceCenter(W / 2, H / 2));

    const link = svg.append("g")
      .selectAll("line")
      .data(links)
      .join("line")
      .attr("stroke-width", 2)
      .attr("stroke", d => d.tipo === "positivo" ? "#2ecc71" : "#e74c3c")
      .attr("stroke-dasharray", d => d.tipo === "negativo" ? "5,5" : "0");

    const arrow = svg.append("defs").selectAll("marker")
      .data(["positivo", "negativo"])
      .join("marker")
      .attr("id", d => `arrow-${d}`)
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 20)
      .attr("refY", 0)
      .attr("markerWidth", 6)
      .attr("markerHeight", 6)
      .attr("orient", "auto")
      .append("path")
      .attr("d", "M0,-5L10,0L0,5")
      .attr("fill", d => d === "positivo" ? "#2ecc71" : "#e74c3c");

    link.attr("marker-end", d => `url(#arrow-${d.tipo})`);

    const node = svg.append("g")
      .selectAll("circle")
      .data(nodes)
      .join("circle")
      .attr("r", d => d.r)
      .attr("fill", (d, i) => i === liderIndex ? "#f1c40f" : "#3498db")
      .attr("stroke", "#222")
      .attr("stroke-width", 2)
      .on("mouseover", function(e, d) {
        tooltip.style("display", "block")
               .html(`<strong>${d.nombre}</strong><br>Votos positivos recibidos: ${d.recPos}<br>Votos negativos recibidos: ${d.recNeg}`);
      })
      .on("mousemove", function(e) {
        tooltip.style("left", (e.pageX + 15) + "px")
               .style("top", (e.pageY - 30) + "px");
      })
      .on("mouseout", () => tooltip.style("display", "none"));

    const label = svg.append("g")
      .selectAll("text")
      .data(nodes)
      .join("text")
      .text(d => `${d.nombre} +${d.recPos} / -${d.recNeg}`)
      .attr("font-size", "12px")
      .attr("text-anchor", "middle")
      .attr("fill", "#fff");

    simulation.on("tick", () => {
      link
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);

      node
        .attr("cx", d => d.x)
        .attr("cy", d => d.y);

      label
        .attr("x", d => d.x)
        .attr("y", d => d.y + 4);
    });

    // Interpretación automática
    function generarInterpretacion() {
      const totalNodos = nodes.length;
      const lider = nodes[liderIndex].nombre;
      const perifericos = nodes.filter(n => n.recPos === 0).map(n => n.nombre);
      const rechazados = nodes.filter(n => n.recNeg >= 4 && n.recPos <= 1).map(n => n.nombre);
      const ambivalentes = nodes.filter(n => n.recPos >= 2 && n.recNeg >= 2).map(n => n.nombre);

      let texto = `El análisis del sociograma revela una estructura relacional donde se identifica como líder sociométrico a <strong>${lider}</strong>, quien ha recibido el mayor número de votos positivos por parte de sus compañeros.`;

      if (perifericos.length > 0) {
        texto += ` Se observa también la presencia de miembros periféricos como ${perifericos.join(", ")}, quienes no han recibido votos positivos.`;
      }

      if (rechazados.length > 0) {
        texto += ` Figuras como ${rechazados.join(", ")} presentan una tendencia al rechazo dentro del grupo, lo cual puede indicar dificultades de integración.`;
      }

      if (ambivalentes.length > 0) {
        texto += ` Algunos participantes como ${ambivalentes.join(", ")} muestran una posición ambivalente en el grupo, recibiendo tanto aceptación como rechazo.`;
      }

      texto += ` Desde la perspectiva de la educación social, es recomendable realizar un seguimiento y posible intervención para fortalecer la cohesión del grupo, potenciar las relaciones positivas y acompañar a quienes se encuentran en posiciones de vulnerabilidad dentro de la red relacional.`;

      document.getElementById("textoInterpretacion").innerHTML = texto;
    }

    generarInterpretacion();
  </script>
</body>
</html>

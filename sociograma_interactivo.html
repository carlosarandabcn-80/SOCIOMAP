<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sociograma ‚Äî SOCIOMAP</title>

  <!-- LIBRER√çAS -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvg/dist/browser/canvg.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      background: #0f172a;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 32px;
      text-align: center;
    }
    h1 {font-size: 36px; color: white;}
    .grupo-nombre {font-size: 20px; color: white; margin-bottom: 12px;}
    .btn { margin: 10px; padding: 10px 18px; font-weight: bold; cursor: pointer; border-radius: 8px; border: none; background: #e5e7eb; color: #0f172a;}
    .btn:hover {background: #cbd5e1;}
    #sociograma { margin: 20px auto; background: white; border-radius: 8px; width: 100%; max-width: 1200px; height: 800px;}
    #chartContainer { margin: 20px auto; background: white; border-radius: 8px; width: 100%; max-width: 1000px;}
    footer {margin-top: 40px;}
    .footer-logo {height: 80px;}
  </style>
</head>

<body>

  <h1>Sociograma Interactivo</h1>
  <div id="grupo-nombre"></div>

  <!-- SOCIOGRAMA D3 -->
  <div id="sociograma"></div>
  <p style="font-size:15px; color:#a5f3fc;">üí° Puedes reorganizar los nodos manualmente para una mejor visualizaci√≥n.</p>

  <!-- EXPORT -->
  <button class="btn" onclick="exportarSociograma()">Exportar Sociograma PNG</button>

  <!-- BARRAS -->
  <div id="chartContainer">
    <canvas id="rankingChart"></canvas>
  </div>
  <p style="font-size:15px; color:#38bdf8;">üí° Gr√°fico interactivo: pasa el cursor para detalles.</p>

  <button class="btn" onclick="exportarGrafico()">Exportar Gr√°fico PNG</button>

  <!-- FOOTER -->
  <footer>
    <img src="logo.png" class="footer-logo" alt="LOGO">
    <p>Gracias por usar Sociomap üíô</p>
  </footer>

<script>
  // BLOQUEAR RETROCESO
  history.pushState(null, null, location.href);
  window.onpopstate = () => history.go(1);

  // CARGAR DATOS DESDE localStorage
  const rawData = JSON.parse(localStorage.getItem("sociogramaData") || "null");
  const grupo = localStorage.getItem("grupoNombre") || "SIN NOMBRE";

  if (!rawData || !rawData.nodes || !rawData.links) {
    document.body.innerHTML = "<h2 style='color:red;'>‚ùå No se encontraron datos sociom√©tricos v√°lidos.</h2><p>Por favor, regresa al formulario y genera el ranking.</p>";
    throw new Error("Datos no encontrados");
  }

  const labels = rawData.nodes.map(n => n.name);
  const nodes = rawData.nodes.map((n, i) => ({
    id: i,
    name: n.name,
    votosPos: n.p,
    votosNeg: n.n
  }));

  const nodeIndexMap = Object.fromEntries(labels.map((name, i) => [name, i]));
  const links = rawData.links.map(l => ({
    source: nodeIndexMap[l.source],
    target: nodeIndexMap[l.target],
    type: l.type
  }));

  const fechaObj = new Date();
  const fechaFormateada = fechaObj.toLocaleDateString("es-ES", {
    year:'numeric', month:'long', day:'numeric'
  });

  document.getElementById("grupo-nombre").textContent = `Grupo: ${grupo} ‚Äî ${fechaFormateada}`;

  // --- D3 SOCIOGRAMA ---
  const width = 1200, height = 800;
  const liderIndex = nodes.reduce((a,c,i,arr) => c.votosPos > arr[a].votosPos ? i : a, 0);

  const svg = d3.select("#sociograma").append("svg")
    .attr("width", width).attr("height", height);

  const sim = d3.forceSimulation(nodes)
    .force("link", d3.forceLink(links).id(d => d.id).distance(150))
    .force("charge", d3.forceManyBody().strength(-350))
    .force("center", d3.forceCenter(width / 2, height / 2));

  const linkElems = svg.append("g").selectAll("line")
    .data(links).enter().append("line")
    .attr("stroke", d => d.type === "+" ? "#22c55e" : "#ef4444")
    .attr("stroke-width", 2);

  const nodeElems = svg.append("g").selectAll("g")
    .data(nodes).enter().append("g")
      .call(d3.drag().on("start", dragStart).on("drag", drag).on("end", dragEnd));

  nodeElems.append("circle")
    .attr("r", d => 30 + d.votosPos * 3)
    .attr("fill", d => d.id === liderIndex ? "#facc15" : "#0ea5e9");

  nodeElems.append("text")
    .text(d => d.name)
    .attr("font-size", "14px")
    .attr("fill", "#fff")
    .attr("text-anchor", "middle")
    .attr("dy", -8);

  sim.on("tick", () => {
    linkElems
      .attr("x1", d => d.source.x)
      .attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x)
      .attr("y2", d => d.target.y);

    nodeElems.attr("transform", d => `translate(${d.x},${d.y})`);
  });

  function dragStart(event, d) {
    if (!event.active) sim.alphaTarget(0.3).restart();
    d.fx = d.x; d.fy = d.y;
  }
  function drag(event, d) {
    d.fx = event.x; d.fy = event.y;
  }
  function dragEnd(event, d) {
    if (!event.active) sim.alphaTarget(0);
    d.fx = null; d.fy = null;
  }

  // --- CHART.JS ---
  new Chart(document.getElementById("rankingChart"), {
    type: 'bar',
    data: {
      labels: nodes.map(n => n.name),
      datasets: [
        { label: "Votos +", data: nodes.map(n => n.votosPos), backgroundColor: "#22c55e" },
        { label: "Votos -", data: nodes.map(n => -n.votosNeg), backgroundColor: "#ef4444" }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        datalabels: {
          color: "#000",
          anchor: 'end',
          align: 'end',
          formatter: val => Math.abs(val)
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  // --- EXPORT FUNCTIONS ---
  async function exportarSociograma() {
    const svgElem = document.querySelector("#sociograma svg");
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = width; tempCanvas.height = height;
    const ctxTemp = tempCanvas.getContext("2d");
    await canvg.Canvg.from(ctxTemp, new XMLSerializer().serializeToString(svgElem)).render();

    const divTemp = document.createElement("div");
    divTemp.style.position = "absolute"; divTemp.style.left = "-9999px";
    divTemp.appendChild(tempCanvas);
    document.body.appendChild(divTemp);

    exportarCanvasConPie(tempCanvas, "sociograma");
    document.body.removeChild(divTemp);
  }

  function exportarGrafico() {
    const grafCanvas = document.querySelector("#rankingChart");
    exportarCanvasConPie(grafCanvas, "ranking");
  }

  function exportarCanvasConPie(canvasOrig, nombre) {
    html2canvas(canvasOrig, { scale: 2 }).then(c => {
      const final = document.createElement("canvas");
      final.width = c.width;
      final.height = c.height + 100;
      const ctx = final.getContext("2d");

      ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, final.width, final.height);
      ctx.drawImage(c, 0, 0);

      const logo = new Image();
      logo.src = "logo.png";
      logo.onload = () => {
        ctx.drawImage(logo, 20, c.height + 10, 60, 60);
        ctx.fillStyle = "#000";
        ctx.font = "14px Arial";
        ctx.fillText(`Grupo: ${grupo} ‚Äî ${fechaFormateada}`, 100, c.height + 40);

        const link = document.createElement("a");
        link.download = `${nombre}_${grupo}.png`;
        link.href = final.toDataURL("image/png");
        link.click();
      };
    });
  }
</script>

</body>
</html>
